rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---- 共通ユーティリティ ----
    function isSignedIn() {
      return request.auth != null;
    }
    function isMember(projectId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }
    function role(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid)).data.role;
    }
    function isAdmin(projectId) {
      return isSignedIn() && role(projectId) == 'admin';
    }
    function isEditor(projectId) {
      return isSignedIn() && (role(projectId) in ['admin','member']);
    }
    function isValidRole(newRole) {
      return newRole in ['admin', 'member', 'viewer'];
    }

    match /projects/{projectId} {

      // ===== Invites（招待リンク）=====
      // 招待ドキュメントの妥当性チェック
      function validInvite(d) {
        return d.keys().hasOnly([
          'email',        // 招待先メール（必須）
          'role',         // 付与ロール（必須）
          'createdBy',    // 作成者UID（必須）
          'createdAt',    // 作成時刻（必須）
          // 以下は任意
          'status',       // 'active' | 'revoked' | 'accepted' など
          'expiresAt',    // 期限（epoch秒 or timestamp）
          'acceptedBy',   // 受諾者UID
          'acceptedAt'    // 受諾時刻
        ])
        && (d.email is string) && d.email.size() > 3 && d.email.size() <= 320
        && isValidRole(d.role)
        && (d.createdBy is string) && d.createdBy == request.auth.uid
        && (d.createdAt is timestamp)
        && (!('status' in d) || (d.status is string && d.status.size() <= 30))
        && (!('expiresAt' in d) || (d.expiresAt is timestamp))
        && (!('acceptedBy' in d) || (d.acceptedBy is string))
        && (!('acceptedAt' in d) || (d.acceptedAt is timestamp));
      }

      // 管理者 or 招待された本人のみ招待の中身を見られる
      match /invites/{inviteId} {
        allow read: if isAdmin(projectId)
                    || (isSignedIn()
                        && request.auth.token.email != null
                        && resource.data.email == request.auth.token.email);

        // 作成：管理者のみ・payload検証
        allow create: if isAdmin(projectId)
                      && validInvite(request.resource.data);

        // 更新：管理者のみ・一部フィールドのみ変更可（取り消し/期限延長/ロール調整/受諾記録）
        allow update: if isAdmin(projectId)
                      && request.resource.data.diff(resource.data).changedKeys()
                         .hasOnly(['status','expiresAt','role','acceptedBy','acceptedAt'])
                      && (!('role' in request.resource.data) || isValidRole(request.resource.data.role));

        // 削除：管理者のみ
        allow delete: if isAdmin(projectId);
      }

      // ===== Analytics（既存）=====
      match /analytics/currentSummary {
        allow read: if isMember(projectId);
        allow create, update, delete: if false;
      }
      match /analyticsPerUser/{uid} {
        allow read: if isMember(projectId)
                    && request.auth != null
                    && request.auth.uid == uid;
        allow create, update, delete: if false;
      }

      match /reports/{reportId} {
        allow read: if isMember(projectId);
        allow create, update, delete: if isEditor(projectId);
      }

      // プロジェクト直下の読み取りはメンバーのみ
      allow read: if isMember(projectId);

      // 監査ログ
      match /auditLogs/{logId} {
        allow read: if isMember(projectId);
        allow create, update, delete: if false;
      }

      // 新規プロジェクト作成
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly(['meta'])
        && request.resource.data.meta.keys().hasOnly(['name','createdBy','createdAt'])
        && request.resource.data.meta.createdBy == request.auth.uid;

      // 既存プロジェクトの更新/削除は admin のみ
      allow update, delete: if isAdmin(projectId);

      // ===== members（既存）=====
      match /members/{uid} {
        allow read: if isMember(projectId);

        // (1) 本人が displayName / email を更新
        allow update: if isSignedIn()
          && request.auth.uid == uid
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['displayName','email'])
          && (request.resource.data.displayName is string)
          && request.resource.data.displayName.size() > 0
          && request.resource.data.displayName.size() <= 120
          && request.auth.token.email != null
          && request.resource.data.email == request.auth.token.email;

        // (2) admin 作成（自己作成 or admin招待）
        allow create: if isSignedIn()
          && request.auth.uid == uid
          && request.resource.data.role == 'admin'
          && (
            // 自己作成
            request.resource.data.keys().hasOnly(['role','joinedAt','displayName','email'])
            ||
            // 招待経由の admin 付与
            (
              request.resource.data.keys().hasOnly(['role','joinedAt','inviteId','invitedBy','displayName','email'])
              && request.auth.token.email != null
              && exists(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId))
              && get(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId)).data.email
                 == request.auth.token.email
            )
          );

        // (3) member/viewer の招待登録
        allow create: if isSignedIn()
          && request.auth.uid == uid
          && (request.resource.data.role in ['member','viewer'])
          && request.resource.data.keys().hasOnly(['role','joinedAt','inviteId','invitedBy','displayName','email'])
          && request.auth.token.email != null
          && exists(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId))
          && get(/databases/$(database)/documents/projects/$(projectId)/invites/$(request.resource.data.inviteId)).data.email
             == request.auth.token.email;

        // (4) 管理者によるロール変更（role のみ）
        allow update: if isAdmin(projectId)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['role'])
          && isValidRole(request.resource.data.role);

        // (5) 削除
        allow delete: if isAdmin(projectId);
      }

      // --- カンバン列（既存）---
      function isValidBoardColumn(col) {
        return col.keys().hasOnly([
          'columnId','title','order','categoryHint','progressHint'
        ])
        && (!('title' in col) || ((col.title is string) && col.title.size() >= 0 && col.title.size() <= 120))
        && (!('order' in col) || (col.order is int || col.order is float))
        && (!('categoryHint' in col) || (col.categoryHint in ['not_started','in_progress','done']))
        && (!('progressHint' in col) || ((col.progressHint is int || col.progressHint is float) && col.progressHint >= 0 && col.progressHint <= 100))
        && (!('columnId' in col) || (col.columnId is string && col.columnId.size() > 0 && col.columnId.size() <= 200));
      }
      match /boardColumns/{columnId} {
        allow read: if isMember(projectId);
        allow create, update: if isEditor(projectId) && isValidBoardColumn(request.resource.data);
        allow delete: if isEditor(projectId);
      }

      // Problems / Issues / Tasks（既存）
      match /problems/{problemId} {
        allow read: if isMember(projectId);

        function validProblemDef(def) {
          return def.keys().hasOnly(['phenomenon','cause','solution','goal','updatedAt','updatedBy'])
            && (def.phenomenon is string) && (def.goal is string)
            && def.phenomenon.matches('^[\\s\\S]{1,1000}$')
            && def.goal.matches('^[\\s\\S]{1,500}$')
            && (!('cause' in def) || (def.cause is string && def.cause.matches('^[\\s\\S]{0,1000}$')))
            && (!('solution' in def) || (def.solution is string && def.solution.matches('^[\\s\\S]{0,1000}$')))
            && (!('updatedBy' in def) || def.updatedBy == request.auth.uid);
        }
        function validAttachmentData(d) {
          return d.keys().hasOnly(['name','contentType','size','storagePath','downloadURL','createdAt','updatedAt','createdBy'])
                 && (d.name is string) && d.name.size() > 0 && d.name.size() <= 200
                 && (d.contentType is string) && d.contentType.size() > 0
                 && ((d.size is int) || (d.size is float)) && d.size >= 0 && d.size <= 20 * 1024 * 1024
                 && (d.storagePath is string) && d.storagePath.size() > 0
                 && (d.downloadURL is string) && d.downloadURL.size() > 0
                 && (d.createdBy is string) && d.createdBy == request.auth.uid;
        }

        allow create, update: if isEditor(projectId)
          && ( !('problemDef' in request.resource.data) || validProblemDef(request.resource.data.problemDef) );
        allow delete: if isEditor(projectId);

        match /attachments/{attId} {
          allow read: if isMember(projectId);
          allow create: if isEditor(projectId) && validAttachmentData(request.resource.data);
          allow update: if isEditor(projectId)
            && request.resource.data.keys().hasOnly(['name','updatedAt'])
            && (request.resource.data.name is string)
            && request.resource.data.name.size() > 0
            && request.resource.data.name.size() <= 200;
          allow delete: if isEditor(projectId);
        }

        match /comments/{commentId} {
            allow read: if isMember(projectId);
            allow create: if isEditor(projectId) && request.resource.data.authorId == request.auth.uid;
            // 作成者のみ編集可。編集できる項目は body / updatedAt のみ
            allow update: if isSignedIn()
                          && resource.data.authorId == request.auth.uid
                          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['body','updatedAt'])
                          && (request.resource.data.body is string)
                          && request.resource.data.body.size() > 0
                          && request.resource.data.body.size() <= 2000;
            // 作成者のみ削除可（admin でも不可）
            allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
          }

        match /issues/{issueId} {
          allow read: if isMember(projectId);
          allow create, update: if isEditor(projectId);
          allow delete: if isEditor(projectId);

          match /attachments/{attId} {
            allow read: if isMember(projectId);
            allow create: if isEditor(projectId) && validAttachmentData(request.resource.data);
            allow update: if isEditor(projectId)
              && request.resource.data.keys().hasOnly(['name','updatedAt'])
              && (request.resource.data.name is string)
              && request.resource.data.name.size() > 0
              && request.resource.data.name.size() <= 200;
            allow delete: if isEditor(projectId);
          }

          match /comments/{commentId} {
            allow read: if isMember(projectId);
            allow create: if isEditor(projectId) && request.resource.data.authorId == request.auth.uid;
            allow update, delete: if ((request.auth != null && resource.data.authorId == request.auth.uid) || isAdmin(projectId));
          }

          match /tasks/{taskId} {
            allow read: if isMember(projectId);
            allow create, update, delete: if isEditor(projectId);

            match /attachments/{attId} {
              allow read: if isMember(projectId);
              allow create: if isEditor(projectId) && validAttachmentData(request.resource.data);
              allow update: if isEditor(projectId)
                && request.resource.data.keys().hasOnly(['name','updatedAt'])
                && (request.resource.data.name is string)
                && request.resource.data.name.size() > 0
                && request.resource.data.name.size() <= 200;
              allow delete: if isEditor(projectId);
            }

            match /comments/{commentId} {
              allow read: if isMember(projectId);
              allow create: if isEditor(projectId) && request.resource.data.authorId == request.auth.uid;
              allow update, delete: if ((request.auth != null && resource.data.authorId == request.auth.uid) || isAdmin(projectId));
            }
          }
        }
      }
    } // end /projects/{projectId}

    // ---- users コレクション（本人専用のサブコレクション制御）----
    match /users/{uid} {
      allow read, write: if false;

      match /memberships/{projectId} {
        allow read: if isSignedIn() && request.auth.uid == uid;
        allow create: if isSignedIn() && request.auth.uid == uid;
        allow update: if isSignedIn() && (
          request.auth.uid == uid ||
          ( isAdmin(projectId)
            && request.resource.data.diff(resource.data).changedKeys().hasOnly(['role'])
            && isValidRole(request.resource.data.role)
          )
        );
        allow delete: if isSignedIn() && (request.auth.uid == uid || isAdmin(projectId));
      }

      match /fcmTokens/{token} {
        allow read: if isSignedIn() && request.auth.uid == uid;
        allow create, update, delete: if isSignedIn() && request.auth.uid == uid;
      }

      match /fcmStatus/{docId} {
        allow read: if isSignedIn() && request.auth.uid == uid;
        allow create, update: if isSignedIn()
          && request.auth.uid == uid
          && request.resource.data.keys().hasOnly(['enabled','lastTokenSavedAt','lastError']);
        allow delete: if false;
      }
    }

    // === collectionGroup('tasks') 用 ===
    match /{path=**}/tasks/{taskId} {
      allow read: if isMember(resource.data.projectId);
      // allow create, update, delete: if isEditor(request.resource.data.projectId);
    }
  }
}







