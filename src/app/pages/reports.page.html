<section class="page reports-page">
  <header class="page__header">
    <h1 class="section-title section-title--info no-truncate">
      {{ 'reports.title' | translate }}
    </h1>
    <p class="page__subtitle">{{ 'reports.subtitle' | translate }}</p>
    <p class="page__subsubtitle">{{ 'reports.subsubtitle' | translate }}</p>
    <p class="page__project" *ngIf="projectName$ | async as projectName">
      {{ 'reports.projectNameLine' | translate:{ name: projectName } }}
    </p>
  </header>

  <mat-card class="reports-page__actions">
    <mat-card-content>
      <div class="reports-page__action-buttons">
        <button mat-raised-button color="primary" type="button" [matMenuTriggerFor]="aiDraftMenu">
          <mat-icon>auto_awesome</mat-icon>
          {{ 'reports.actions.generateAi' | translate }}
        </button>
        <mat-menu #aiDraftMenu="matMenu">
          <button mat-menu-item (click)="generateDraftBy('personal', 'weekly')">
            {{ 'reports.actions.ai.personalWeekly' | translate }}
          </button>
          <button mat-menu-item (click)="generateDraftBy('project', 'weekly')">
            {{ 'reports.actions.ai.projectWeekly' | translate }}
          </button>
        </mat-menu>

        <button mat-stroked-button color="primary" type="button" (click)="addManualReport()">
          <mat-icon>edit_note</mat-icon>
          {{ 'reports.actions.addManual' | translate }}
        </button>
      </div>

      <!-- AI下書き生成後もここに流し込んで編集→保存できる -->
      <form *ngIf="manualFormOpen" class="reports-page__manual-form" (ngSubmit)="saveReport('manual')">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'reports.form.titleLabel' | translate }}</mat-label>
          <input
            matInput name="title"
            [(ngModel)]="draftReport.title" required
            placeholder="{{ 'reports.form.titlePlaceholder' | translate }}" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'reports.form.bodyLabel' | translate }}</mat-label>
          <textarea
            matInput name="body" rows="5"
            [(ngModel)]="draftReport.body" required
            placeholder="{{ 'reports.form.bodyPlaceholder' | translate }}"></textarea>
        </mat-form-field>

        <div class="reports-page__manual-form-actions">
          <button mat-stroked-button type="button" (click)="cancelManualReport()">
            {{ 'reports.form.cancel' | translate }}
          </button>
          <button mat-flat-button color="primary" type="submit">
            {{ 'reports.form.save' | translate }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <div class="reports-page__content">
    <!-- 過去レポート（カード化） -->
    <mat-card class="reports-page__list">
      <mat-card-header>
        <mat-card-title>{{ 'reports.list.title' | translate }}</mat-card-title>
      </mat-card-header>

      <mat-card-content *ngIf="reports$ | async as reports">
        <div class="reports-page__card-list" *ngIf="reports.length; else emptyList">
          <div
            class="report-card"
            *ngFor="let report of reports"
            role="button"
            tabindex="0"
            (click)="setActiveReport(report)"
            (keydown.enter)="setActiveReport(report)"
            (keydown.space)="setActiveReport(report)"
            [class.active]="report.id === activeReport?.id">
            <div class="report-card__title">{{ report.title }}</div>
            <div class="report-card__meta">
              <span>{{ createdAtToDate(report.createdAt) | date: 'yyyy/MM/dd' : undefined : dateLocale }}</span>
              <span class="dot" *ngIf="report.createdBy || report.createdByName">•</span>
              <span class="report-card__author" *ngIf="report.createdBy || report.createdByName">
                {{ report.createdByName || report.createdBy }}
              </span>
            </div>
          </div>
        </div>

        <ng-template #emptyList>
          <p class="muted">{{ 'reports.list.empty' | translate }}</p>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- プレビュー -->
    <mat-card class="reports-page__preview" *ngIf="activeReport as report">
      <mat-card-header>
        <mat-card-title>{{ report.title }}</mat-card-title>
        <mat-card-subtitle>
          {{ createdAtToDate(report.createdAt) | date: 'yyyy/MM/dd (EEE)' : undefined : dateLocale }}
        </mat-card-subtitle>
      </mat-card-header>

      <!-- draftを直接保存したい人向けのボタン（残置） -->
      <mat-card-actions *ngIf="report.id?.startsWith('draft-')">
        <button mat-flat-button color="primary" type="button" (click)="saveReport('active')">
          {{ 'reports.form.save' | translate }}
        </button>
      </mat-card-actions>

      <!-- 作成者のみ編集/削除 -->
      <mat-card-actions *ngIf="!report.id?.startsWith('draft-') && isMine(report)">
        <button mat-stroked-button type="button" (click)="editReport(report)">
          {{ 'common.edit' | translate }}
        </button>
        <button mat-stroked-button color="warn" type="button" (click)="onDeleteReport(report)">
          {{ 'common.delete' | translate }}
        </button>
      </mat-card-actions>

      <mat-divider></mat-divider>
      <mat-card-content>
        <p class="reports-page__preview-body">{{ report.body }}</p>
        <!-- 指標メモ（metrics）は非表示 -->
      </mat-card-content>
    </mat-card>
  </div>
</section>




