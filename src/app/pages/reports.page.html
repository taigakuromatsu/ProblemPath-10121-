<section class="page reports-page">
  <header class="page__header">
    <h1 class="section-title section-title--info no-truncate">
      {{ 'reports.title' | translate }}
    </h1>
    <p class="page__subtitle">{{ 'reports.subtitle' | translate }}</p>
    <p class="page__project" *ngIf="projectId$ | async as projectId">
      {{ 'reports.projectContext' | translate: { id: projectId } }}
    </p>
  </header>

  <mat-card class="reports-page__actions">
    <mat-card-content>
      <div class="reports-page__action-buttons">
        <button mat-raised-button color="primary" type="button" [matMenuTriggerFor]="aiDraftMenu">
          <mat-icon>auto_awesome</mat-icon>
          {{ 'reports.actions.generateAi' | translate }}
        </button>
        <mat-menu #aiDraftMenu="matMenu">
          <button mat-menu-item (click)="generateDraftBy('personal', 'weekly')">
            {{ 'reports.actions.ai.personalWeekly' | translate }}
          </button>
          <button mat-menu-item (click)="generateDraftBy('project', 'weekly')">
            {{ 'reports.actions.ai.projectWeekly' | translate }}
          </button>
        </mat-menu>

        <button mat-stroked-button color="primary" type="button" (click)="addManualReport()">
          <mat-icon>edit_note</mat-icon>
          {{ 'reports.actions.addManual' | translate }}
        </button>
      </div>

      <form *ngIf="manualFormOpen" class="reports-page__manual-form" (ngSubmit)="saveReport('manual')">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'reports.form.titleLabel' | translate }}</mat-label>
          <input
            matInput name="title" [(ngModel)]="draftReport.title" required
            placeholder="{{ 'reports.form.titlePlaceholder' | translate }}"
          />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'reports.form.bodyLabel' | translate }}</mat-label>
          <textarea
            matInput name="body" rows="5" [(ngModel)]="draftReport.body" required
            placeholder="{{ 'reports.form.bodyPlaceholder' | translate }}"
          ></textarea>
        </mat-form-field>

        <div class="reports-page__manual-form-actions">
          <button mat-stroked-button type="button" (click)="cancelManualReport()">
            {{ 'reports.form.cancel' | translate }}
          </button>
          <button mat-flat-button color="primary" type="submit">
            {{ 'reports.form.save' | translate }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <div class="reports-page__content">
    <!-- 左：一覧 -->
    <mat-card class="reports-page__list">
      <mat-card-header>
        <mat-card-title>{{ 'reports.list.title' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content *ngIf="reports$ | async as reports">
        <mat-nav-list class="reports-list">
          <a
            mat-list-item
            *ngFor="let report of reports"
            (click)="setActiveReport(report)"
            [activated]="report.id === activeReport?.id"
          >
            <div matListItemTitle class="item-title">
              {{ report.title }}
            </div>
            <div matListItemLine class="item-meta">
              <span class="date">{{ createdAtToDate(report.createdAt) | date: 'yyyy/MM/dd' }}</span>
              <span class="dot">•</span>
              <span class="summary ellipsis">{{ report.metrics.notes }}</span>
              <span class="dot" *ngIf="report.createdBy || report.createdByName">•</span>
              <span class="author" *ngIf="report.createdBy || report.createdByName">
                {{ report.createdByName || report.createdBy }}
              </span>
            </div>
          </a>
        </mat-nav-list>
        <p *ngIf="!reports.length" class="muted">{{ 'reports.list.empty' | translate }}</p>
      </mat-card-content>
    </mat-card>

    <!-- 右：プレビュー -->
    <mat-card class="reports-page__preview" *ngIf="activeReport as report">
      <mat-card-header>
        <mat-card-title>{{ report.title }}</mat-card-title>
        <mat-card-subtitle>
          {{ createdAtToDate(report.createdAt) | date: 'yyyy/MM/dd (EEE)' }}
        </mat-card-subtitle>
      </mat-card-header>

      <!-- 下書き保存（新規作成） -->
      <mat-card-actions *ngIf="report.id?.startsWith('draft-')">
        <button mat-flat-button color="primary" type="button" (click)="saveReport('active')">
          {{ 'reports.form.save' | translate }}
        </button>
      </mat-card-actions>

      <!-- 既存レポートの作成者（または作者情報なし＝レガシー）だけ編集/削除 -->
      <mat-card-actions *ngIf="!report.id?.startsWith('draft-') && canEdit(report)">
        <button mat-stroked-button type="button" (click)="editReport(report)">編集</button>
        <button mat-stroked-button color="warn" type="button" (click)="deleteReport(report)">削除</button>
      </mat-card-actions>

      <mat-divider></mat-divider>
      <mat-card-content>
        <p class="reports-page__preview-body">{{ report.body }}</p>
        <div class="reports-page__preview-meta" *ngIf="report.metrics as metrics">
          <h3>{{ 'reports.preview.metricsTitle' | translate }}</h3>
          <ul>
            <li *ngIf="metrics.completedTasks !== undefined">
              {{ 'reports.preview.completedTasks' | translate }}: {{ metrics.completedTasks }}
            </li>
            <li *ngIf="metrics.avgProgressPercent !== undefined">
              {{ 'reports.preview.avgProgress' | translate }}: {{ metrics.avgProgressPercent }}%
            </li>
            <li *ngIf="metrics.notes">
              {{ 'reports.preview.notes' | translate }}: {{ metrics.notes }}
            </li>
          </ul>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</section>


