<section class="home-page">
  <header class="page-header">
    <div class="intro-text">
      <h1 class="section-title section-title--info no-truncate">{{ 'home.title' | translate }}</h1>
      <p class="page-subtitle text-2line">{{ 'home.lead' | translate }}</p>
    </div>

    <mat-card class="card intro-card notif-card" *ngIf="auth.loggedIn$ | async">
      <div class="section-header">
        <div>
          <h2 class="section-title section-title--info no-truncate">
            <mat-icon aria-hidden="true">notifications</mat-icon> {{ t('home.notifications.title','最新通知') }}
          </h2>
          <p class="section-subtitle text-2line">{{ t('home.notifications.lead','フォアグラウンドの通知履歴をチェックできます。') }}</p>
        </div>

        <div class="section-actions">
          <ng-container *ngIf="fcmStatus$ | async as s">
            <span class="chip" [class.chip--ok]="s?.enabled === true" [class.chip--ng]="s?.enabled === false">
              {{ s?.enabled ? t('home.notifications.enabled','有効') : t('home.notifications.disabled','未設定') }}
            </span>
            <span class="chip chip--warn" *ngIf="s?.lastError">
              {{ t('home.notifications.error','エラー') }}: {{ s.lastError }}
            </span>
          </ng-container>

          <button mat-raised-button color="primary" type="button" (click)="askNotificationPermission()">
            {{ t('home.notifications.enableBtn','通知を有効化') }}
          </button>
        </div>
      </div>

      <mat-divider></mat-divider>

      <div class="section-body">
        <div class="notification-list" *ngIf="fgMessages.length > 0; else noMessages">
          <div class="notification-item" *ngFor="let m of fgMessages">
            <strong class="no-truncate">{{ m.title || t('home.notifications.itemTitle','通知') }}</strong>
            <span class="muted">{{ m.body || '' }}</span>
          </div>
        </div>
        <ng-template #noMessages>
          <div class="empty-state">（まだありません）</div>
        </ng-template>
      </div>
    </mat-card>
  </header>

  <!-- Alerts -->
  <div class="page-alerts" *ngIf="auth.loggedIn$ | async">
    <mat-card class="card alert-card alert-card--offline" *ngIf="!(isOnline$ | async)">
      <mat-icon>signal_wifi_off</mat-icon>
      <span>{{ 'warn.offlineEditBlocked' | translate }}</span>
    </mat-card>

    <mat-card class="card alert-card alert-card--viewer" *ngIf="!(members.isEditor$ | async)">
      <mat-icon>visibility</mat-icon>
      <span>{{ 'warn.viewerOnly' | translate }}</span>
    </mat-card>
  </div>

  <ng-container *ngIf="auth.loggedIn$ | async; else guestState">
    <div class="home-layout">
      <div class="utility-grid">
        <mat-card class="card util-card invite-card" *ngIf="(members.isAdmin$ | async)">
          <div class="section-header">
            <div>
              <h2 class="section-title section-title--info no-truncate">
                <mat-icon aria-hidden="true">person_add</mat-icon> {{ 'invite.byEmailTitle' | translate }}
              </h2>
              <p class="section-subtitle">メールでチームメンバーを招待します。</p>
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="section-body">
            <form class="inline-form invite-form" (ngSubmit)="$event.preventDefault()">
              <input [(ngModel)]="inviteEmail" name="inviteEmail" placeholder="email@example.com" />
              <select [(ngModel)]="inviteRole" name="inviteRole">
                <option value="admin">{{ 'role.adminLabel' | translate }}</option>
                <option value="member" selected>{{ 'role.memberLabel' | translate }}</option>
                <option value="viewer">{{ 'role.viewerLabel' | translate }}</option>
              </select>
              <button mat-raised-button color="primary" type="button" (click)="createInvite()" [disabled]="isCreatingInvite || !(isOnline$ | async)">
                {{ isCreatingInvite ? ('common.creating' | translate) : ('invite.createLink' | translate) }}
              </button>
            </form>

            <div class="invite-result" *ngIf="inviteUrl">
              <input [value]="inviteUrl" readonly />
              <button mat-stroked-button type="button" (click)="copyInviteUrl()">{{ 'common.copy' | translate }}</button>
            </div>

            <p class="muted">{{ 'invite.helpText' | translate }}</p>
          </div>
        </mat-card>

        <mat-card class="card util-card prefs-card">
          <div class="section-header">
            <div>
              <h2 class="section-title section-title--info no-truncate">
                <mat-icon aria-hidden="true">tune</mat-icon> {{ 'settings.titlePreview' | translate }}
              </h2>
              <p class="section-subtitle">{{ 'settings.lead' | translate }}</p>
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="section-body">
            <pre>{{ (prefs.prefs$ | async) | json }}</pre>
          </div>
        </mat-card>

        <mat-card class="card util-card language-card">
          <div class="section-header">
            <div>
              <h2 class="section-title section-title--info no-truncate">
                <mat-icon aria-hidden="true">language</mat-icon> {{ 'settings.languageTitle' | translate }}
              </h2>
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="section-body">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'settings.languageSelect' | translate }}</mat-label>
              <mat-select [(ngModel)]="lang" (selectionChange)="onLangChange($event.value)">
                <mat-option value="ja">日本語</mat-option>
                <mat-option value="en">English</mat-option>
              </mat-select>
              <mat-icon matSuffix>expand_more</mat-icon>
            </mat-form-field>
          </div>
        </mat-card>

        <mat-card class="card util-card theme-card">
          <div class="section-header">
            <div>
              <h2 class="section-title section-title--info no-truncate">
                <mat-icon aria-hidden="true">dark_mode</mat-icon> {{ 'settings.themeTitle' | translate }}
              </h2>
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="section-body">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'settings.themeSelect' | translate }}</mat-label>
              <mat-select [(ngModel)]="themeMode" (selectionChange)="onThemeChange($event.value)">
                <mat-option value="light">{{ 'theme.light' | translate }}</mat-option>
                <mat-option value="dark">{{ 'theme.dark' | translate }}</mat-option>
                <mat-option value="system">{{ 'theme.system' | translate }}</mat-option>
              </mat-select>
              <mat-icon matSuffix>expand_more</mat-icon>
            </mat-form-field>
          </div>
        </mat-card>
      </div>

      <mat-card class="card problem-card">
        <div class="section-header problem-card__header">
          <div>
            <h2 class="section-title section-title--info no-truncate">
              <mat-icon aria-hidden="true">topic</mat-icon> 問題（Problem）を選択
            </h2>
            <p class="section-subtitle text-2line">ここで選んだ Problem の配下を管理します。</p>
          </div>
          <div class="section-actions">
            <button mat-stroked-button type="button" (click)="openNewProblemDialog()" [disabled]="!(canEdit$ | async)">＋ 新規作成</button>
          </div>
        </div>

        <div class="section-body problem-card__section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Problem を選択</mat-label>
            <mat-select [ngModel]="selectedProblemId" (ngModelChange)="onSelectProblem($event)">
              <mat-option [value]="NEW_OPTION_VALUE">＋ 新規作成…</mat-option>
              <mat-option *ngFor="let p of (problems$ | async)" [value]="p.id">{{ p.title }}</mat-option>
            </mat-select>
            <mat-icon matSuffix>expand_more</mat-icon>
          </mat-form-field>
          <p class="empty-state" *ngIf="!(problems$ | async)?.length">まだ Problem がありません。「新規作成」から追加してください。</p>
        </div>

        <ng-container *ngIf="selectedProblemId as pid">
          <mat-divider class="problem-card__divider"></mat-divider>

          <section class="problem-card__section">
            <div class="section-header">
              <div>
                <h3 class="section-title section-title--info no-truncate">
                  <mat-icon aria-hidden="true">assignment</mat-icon> {{ 'problemDef.title' | translate }}
                </h3>
                <p class="section-subtitle text-2line">選択中の課題の定義を確認します。</p>
              </div>

              <ng-container *ngIf="members.isEditor$ | async">
                <ng-container *ngIf="selectedProblemDoc$ | async as p">
                  <button mat-stroked-button type="button" (click)="openEditProblemDef(p)">
                    {{ 'common.edit' | translate }}
                  </button>
                </ng-container>
              </ng-container>
            </div>

            <div class="section-body" *ngIf="selectedProblemDoc$ | async as p">
              <dl class="problem-def">
                <div>
                  <dt>{{ 'field.phenomenon' | translate }}</dt>
                  <dd>{{ p.problemDef?.phenomenon || '—' }}</dd>
                </div>
                <div *ngIf="p.problemDef?.cause">
                  <dt>{{ 'field.cause' | translate }}</dt>
                  <dd>{{ p.problemDef?.cause }}</dd>
                </div>
                <div *ngIf="p.problemDef?.solution">
                  <dt>{{ 'field.solution' | translate }}</dt>
                  <dd>{{ p.problemDef?.solution }}</dd>
                </div>
                <div>
                  <dt>{{ 'field.goal' | translate }}</dt>
                  <dd>{{ p.problemDef?.goal || '—' }}</dd>
                </div>
                <div class="muted" *ngIf="getUpdatedAtDate(p) as d">
                  {{ 'common.lastUpdated' | translate }}：{{ d | date:'yyyy/MM/dd HH:mm' }}
                </div>
              </dl>
            </div>
          </section>

          <mat-divider class="problem-card__divider"></mat-divider>

          <section class="problem-card__section">
            <div class="section-header">
              <div>
                <h3 class="section-title section-title--info no-truncate">
                  <mat-icon aria-hidden="true">playlist_add_check</mat-icon> {{ 'issue.listTitle' | translate }}
                </h3>
                <p class="section-subtitle text-2line">課題とタスクをまとめて管理します。</p>
              </div>
            </div>

            <div class="section-body">
              <form class="inline-form" *ngIf="members.isEditor$ | async" (ngSubmit)="createIssue(pid)">
                <input [(ngModel)]="issueTitle" name="issueTitle" [placeholder]="'issue.placeholderNewTitle' | translate" required (ngModelChange)="onIssueTitleChange($event)" />
                <button mat-raised-button color="primary" type="submit" [disabled]="!(canEdit$ | async)">＋ {{ 'issue.add' | translate }}</button>
              </form>

              <div *ngIf="selectedProblemDoc$ | async as prob">
                <pp-ai-issue-suggest
                  [problem]="prob"
                  [disabled]="!(canEdit$ | async)"
                  (pick)="issueTitle = $event">
                </pp-ai-issue-suggest>
              </div>

              <ng-container *ngIf="issues$ | async as issues; else loadingIssues">
                <div class="issue-list" *ngIf="issues.length > 0; else emptyIssues">
                  <article class="issue-item" *ngFor="let i of issues">
                    <header class="issue-header">
                      <h3 class="section-title section-title--info no-truncate">
                        <mat-icon aria-hidden="true">label_important</mat-icon> {{ i.title }}
                      </h3>
                      <div class="issue-actions" *ngIf="members.isEditor$ | async">
                        <button mat-stroked-button type="button" (click)="renameIssue(pid, i)" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                        <button mat-stroked-button color="warn" type="button" (click)="removeIssue(pid, i)" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                      </div>
                    </header>

                    <!-- → リンク機能は廃止 -->


                    <section class="issue-tasks">
                      <header class="tasks-header">
                        <h4 class="section-title section-title--info no-truncate">
                          <mat-icon aria-hidden="true">checklist</mat-icon> タスク
                        </h4>
                      </header>

                      <form class="task-form" *ngIf="members.isEditor$ | async" (ngSubmit)="createTask(pid, i.id!)">
                        <div class="task-form__row">
                          <input [(ngModel)]="taskTitle[i.id!]" name="taskTitle-{{ i.id }}" [placeholder]="'task.placeholderNewTitle' | translate" required (ngModelChange)="onTaskTitleChange(i.id!, taskTitle[i.id!])" />
                          <input type="date" [(ngModel)]="taskDueDate[i.id!]" name="taskDueDate-{{ i.id }}" [attr.placeholder]="t('task.duePlaceholder','YYYY-MM-DD')" />
                          <button mat-stroked-button type="submit" [disabled]="!(canEdit$ | async)">＋ {{ 'task.add' | translate }}</button>
                        </div>
                        <div class="task-form__recurrence">
                          <label class="task-form__recurrence-toggle">
                            <input type="checkbox" [(ngModel)]="taskRecurrenceEnabled[i.id!]" (ngModelChange)="onRecurrenceToggle(i.id!, $event)" name="taskRecurrenceEnabled-{{ i.id }}" />
                            <span>{{ 'recurrence.title' | translate }}</span>
                          </label>
                          <div class="task-form__recurrence-fields" *ngIf="taskRecurrenceEnabled[i.id!]">
                            <span class="task-form__recurrence-field">
                              <label>{{ 'recurrence.freqLabel' | translate }}</label>
                              <select [(ngModel)]="taskRecurrenceFreq[i.id!]" name="taskRecurrenceFreq-{{ i.id }}">
                                <option value="DAILY">{{ 'recurrence.freq.daily' | translate }}</option>
                                <option value="WEEKLY">{{ 'recurrence.freq.weekly' | translate }}</option>
                                <option value="MONTHLY">{{ 'recurrence.freq.monthly' | translate }}</option>
                              </select>
                            </span>
                            <span class="task-form__recurrence-field">
                              <label>{{ 'recurrence.interval' | translate }}</label>
                              <input type="number" min="1" step="1" [(ngModel)]="taskRecurrenceInterval[i.id!]" name="taskRecurrenceInterval-{{ i.id }}" />
                              <span class="task-form__recurrence-suffix">{{ 'recurrence.intervalSuffix' | translate }}</span>
                            </span>
                            <span class="task-form__recurrence-field">
                                  <label>{{ 'recurrence.endDate' | translate }}</label>
                                  <input type="date" [(ngModel)]="taskRecurrenceEndDate[i.id!]" name="taskRecurrenceEndDate-{{ i.id }}" />
                                </span>
                                <span class="task-form__recurrence-hint">
                                  {{ 'recurrence.hintShort' | translate }}
                                </span>
                          </div>
                        </div>
                      </form>

                      <ul class="task-list" *ngIf="tasksMap[i.id!] | async as tasks">
                        <li *ngFor="let t of tasks" class="task-item">
                          <div class="task-main">
                            <div class="task-title-row">
                              <span class="task-title text-1line no-truncate">{{ t.title }}</span>
                              <span class="task-template-chip" *ngIf="t.recurrenceTemplate">{{ 'recurrence.templateChip' | translate }}</span>
                            </div>
                            <!-- テンプレの設定を見える化 -->
                            <div class="task-recur-meta" *ngIf="t.recurrenceTemplate">
                                <small>
                                  開始: {{ t.recurrenceAnchorDate || '—' }}
                                  <span *ngIf="t.recurrenceEndDate"> / 終了: {{ t.recurrenceEndDate }}</span>
                                  /
                                  繰り返し:
                                  <ng-container [ngSwitch]="t.recurrenceRule?.freq">
                                    <span *ngSwitchCase="'DAILY'">{{ t.recurrenceRule?.interval || 1 }}日ごと</span>
                                    <span *ngSwitchCase="'WEEKLY'">{{ t.recurrenceRule?.interval || 1 }}週ごと</span>
                                    <span *ngSwitchCase="'MONTHLY'">{{ t.recurrenceRule?.interval || 1 }}か月ごと</span>
                                  </ng-container>
                                </small>
                              </div>
                            <span class="task-meta" *ngIf="t.dueDate">{{ 'task.dueShort' | translate:{ date: t.dueDate } }}</span>
                            <span class="task-tags">
                              <ng-container *ngIf="(t.tags?.length ?? 0) > 0; else noTags">
                                #{{ t.tags!.join(' #') }}
                              </ng-container>
                              <ng-template #noTags>{{ 'tag.none' | translate }}</ng-template>
                            </span>
                          </div>
                          <div class="task-actions" *ngIf="members.isEditor$ | async">
                            <button mat-button type="button" (click)="renameTask(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                            <button mat-button type="button" *ngIf="!t.recurrenceTemplate" (click)="editTaskDue(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'task.editDue' | translate }}</button>
                            <button mat-button type="button" *ngIf="!t.recurrenceTemplate" (click)="editTaskTags(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'task.editTags' | translate }}</button>
                            <button mat-button color="warn" type="button" *ngIf="!t.recurrenceTemplate" (click)="removeTask(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                            <button mat-button type="button" color="primary" *ngIf="t.recurrenceTemplate" (click)="stopRecurrence(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'recurrence.stop' | translate }}</button>
                          </div>
                        </li>
                        <li class="empty-state" *ngIf="tasks.length === 0">{{ 'task.noneYet' | translate }}</li>
                      </ul>
                    </section>
                  </article>
                </div>

                <ng-template #emptyIssues>
                  <div class="empty-state">{{ 'issue.noneYet' | translate }}</div>
                </ng-template>
              </ng-container>

              <ng-template #loadingIssues>
                <div class="empty-state">{{ 'issue.loading' | translate }}</div>
              </ng-template>
            </div>
          </section>
        </ng-container>
      </mat-card>
    </div>
    
    <!-- New Problem Dialog -->
    <div class="overlay" *ngIf="newProblemOpen">
      <div class="dialog">
        <header class="dialog-header">
          <h3>{{ 'problem.create' | translate }}</h3>
          <button mat-icon-button type="button" (click)="closeNewProblemDialog()"><mat-icon>close</mat-icon></button>
        </header>
        <div class="dialog-body">
          <label>
            <span>{{ 'field.titleRequired' | translate }}</span>
            <input [(ngModel)]="newProblem.title" (ngModelChange)="onNewProblemChange('title', newProblem.title)" />
          </label>
          <label class="inline">
            <span>{{ 'field.template' | translate }}</span>
            <select [(ngModel)]="newProblem.template" (ngModelChange)="applyProblemTemplate($event); onNewProblemChange('template', newProblem.template)">
              <option value="bug">{{ 'template.bug' | translate }}</option>
              <option value="improve">{{ 'template.improve' | translate }}</option>
            </select>
          </label>
          <label>
            <span>{{ 'problem.phenomenonRequired' | translate }}</span>
            <textarea rows="3" [(ngModel)]="newProblem.phenomenon" (ngModelChange)="onNewProblemChange('phenomenon', newProblem.phenomenon)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.causeOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="newProblem.cause" (ngModelChange)="onNewProblemChange('cause', newProblem.cause)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.solutionOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="newProblem.solution" (ngModelChange)="onNewProblemChange('solution', newProblem.solution)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.goalRequired' | translate }}</span>
            <textarea rows="2" [(ngModel)]="newProblem.goal" (ngModelChange)="onNewProblemChange('goal', newProblem.goal)"></textarea>
            <small>{{ 'hint.goalKpi' | translate }}</small>
          </label>
        </div>
        <footer class="dialog-footer">
          <button mat-stroked-button type="button" (click)="closeNewProblemDialog()">{{ 'common.cancel' | translate }}</button>
          <button mat-raised-button color="primary" type="button" (click)="createProblemWithDefinition()" [disabled]="!(canEdit$ | async)">{{ 'common.create' | translate }}</button>
        </footer>
      </div>
    </div>

    <!-- Edit Problem Dialog -->
    <div class="overlay" *ngIf="editProblemOpen">
      <div class="dialog">
        <header class="dialog-header">
          <h3>{{ 'problemDef.edit' | translate }}</h3>
          <button mat-icon-button type="button" (click)="closeEditProblemDialog()"><mat-icon>close</mat-icon></button>
        </header>
        <div class="dialog-body">
          <label>
            <span>{{ 'field.titleReadonly' | translate }}</span>
            <input [value]="editProblem.title" readonly />
          </label>
          <label>
            <span>{{ 'problem.phenomenonRequired' | translate }}</span>
            <textarea rows="3" [(ngModel)]="editProblem.phenomenon" (ngModelChange)="onEditProblemChange('phenomenon', editProblem.phenomenon)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.causeOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="editProblem.cause" (ngModelChange)="onEditProblemChange('cause', editProblem.cause)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.solutionOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="editProblem.solution" (ngModelChange)="onEditProblemChange('solution', editProblem.solution)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.goalRequired' | translate }}</span>
            <textarea rows="2" [(ngModel)]="editProblem.goal" (ngModelChange)="onEditProblemChange('goal', editProblem.goal)"></textarea>
          </label>
        </div>
        <footer class="dialog-footer">
          <button mat-stroked-button type="button" (click)="closeEditProblemDialog()">{{ 'common.cancel' | translate }}</button>
          <button mat-raised-button color="primary" type="button" (click)="saveEditedProblemDef()" [disabled]="!(canEdit$ | async)">{{ 'common.save' | translate }}</button>
        </footer>
      </div>
    </div>
  </ng-container>

  <ng-template #guestState>
    <mat-card class="card guest-card">
      <h2 class="no-truncate">{{ 'home.needSignIn' | translate }}</h2>
      <p>{{ 'home.viewOnlyHint' | translate }}</p>
      <p class="muted">
        (<a routerLink="/tree">{{ 'nav.tree' | translate }}</a> /
        <a routerLink="/board">{{ 'nav.board' | translate }}</a> /
        <a routerLink="/schedule">{{ 'nav.schedule' | translate }}</a>)
      </p>
    </mat-card>
  </ng-template>
</section>

