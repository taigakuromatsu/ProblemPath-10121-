<section class="home-page">
  <header class="page-header">
    <div class="page-titles">
      <h1 class="title text-1line">{{ 'home.title' | translate }}</h1>
      <p class="page-subtitle text-2line">{{ 'home.lead' | translate }}</p>
    </div>
  </header>

  <div class="page-alerts" *ngIf="auth.loggedIn$ | async">
    <mat-card class="card alert-card alert-card--offline" *ngIf="!(isOnline$ | async)">
      <mat-icon>signal_wifi_off</mat-icon>
      <span>{{ 'warn.offlineEditBlocked' | translate }}</span>
    </mat-card>

    <mat-card class="card alert-card alert-card--viewer" *ngIf="!(members.isEditor$ | async)">
      <mat-icon>visibility</mat-icon>
      <span>{{ 'warn.viewerOnly' | translate }}</span>
    </mat-card>
  </div>

  <ng-container *ngIf="auth.loggedIn$ | async; else guestState">
    <div class="home-sections">
      <mat-card class="card section-card notifications-card">
        <div class="section-header">
          <div>
            <h2 class="title text-1line">最新通知</h2>
            <p class="section-subtitle text-2line">フォアグラウンドの通知履歴をチェックできます。</p>
          </div>
          <button mat-raised-button color="primary" type="button" (click)="askNotificationPermission()">
            通知を有効化
          </button>
        </div>
        <div class="section-body">
          <div class="notification-token" *ngIf="fcmToken">
            <span class="token-label">Token</span>
            <code>{{ fcmToken }}</code>
          </div>
          <div class="notification-list" *ngIf="fgMessages.length > 0; else noMessages">
            <div class="notification-item" *ngFor="let m of fgMessages">
              <strong>{{ m.title || '通知' }}</strong>
              <span>{{ m.body || '' }}</span>
            </div>
          </div>
          <ng-template #noMessages>
            <div class="empty-state">（まだありません）</div>
          </ng-template>
        </div>
      </mat-card>

      <mat-card class="card section-card problem-card">
        <div class="section-header">
          <div>
            <h2 class="title text-1line">問題の選択</h2>
            <p class="section-subtitle text-2line">対象の課題を選択して詳細を管理します。</p>
          </div>
          <div class="section-actions" *ngIf="members.isEditor$ | async">
            <button mat-stroked-button type="button" (click)="renameSelected()" *ngIf="selectedProblemId" [disabled]="!(canEdit$ | async)">
              {{ 'common.rename' | translate }}
            </button>
            <button mat-stroked-button color="warn" type="button" (click)="removeSelected()" *ngIf="selectedProblemId" [disabled]="!(canEdit$ | async)">
              {{ 'common.delete' | translate }}
            </button>
          </div>
        </div>

        <div class="section-body">
          <label class="problem-select">
            <span>{{ 'label.problem' | translate }}</span>
            <select [(ngModel)]="selectedProblemId" (ngModelChange)="onSelectProblem($event)">
              <option [ngValue]="null">{{ 'common.selectPrompt' | translate }}</option>
              <option *ngFor="let p of (problems$ | async)" [ngValue]="p.id">{{ p.title }}</option>
              <option *ngIf="members.isEditor$ | async" [ngValue]="NEW_OPTION_VALUE">＋ {{ 'common.createNewEllipsis' | translate }}</option>
            </select>
          </label>
        </div>
      </mat-card>

      <mat-card class="card section-card" *ngIf="selectedProblemId as pid">
        <div class="section-header">
          <div>
            <h2 class="title text-1line">{{ 'problemDef.title' | translate }}</h2>
            <p class="section-subtitle text-2line">選択中の課題の定義を確認します。</p>
          </div>

          <!-- ★ 修正ポイント：二段の ng-container で安全に p を取り出す -->
          <ng-container *ngIf="members.isEditor$ | async">
            <ng-container *ngIf="selectedProblemDoc$ | async as p">
              <button mat-stroked-button type="button" (click)="openEditProblemDef(p)">
                {{ 'common.edit' | translate }}
              </button>
            </ng-container>
          </ng-container>
        </div>

        <div class="section-body" *ngIf="selectedProblemDoc$ | async as p">
          <dl class="problem-def">
            <div>
              <dt>{{ 'field.phenomenon' | translate }}</dt>
              <dd>{{ p.problemDef?.phenomenon || '—' }}</dd>
            </div>
            <div *ngIf="p.problemDef?.cause">
              <dt>{{ 'field.cause' | translate }}</dt>
              <dd>{{ p.problemDef?.cause }}</dd>
            </div>
            <div *ngIf="p.problemDef?.solution">
              <dt>{{ 'field.solution' | translate }}</dt>
              <dd>{{ p.problemDef?.solution }}</dd>
            </div>
            <div>
              <dt>{{ 'field.goal' | translate }}</dt>
              <dd>{{ p.problemDef?.goal || '—' }}</dd>
            </div>
            <div class="muted" *ngIf="getUpdatedAtDate(p) as d">
              {{ 'common.lastUpdated' | translate }}：{{ d | date:'yyyy/MM/dd HH:mm' }}
            </div>
          </dl>
        </div>
      </mat-card>

      <mat-card class="card section-card" *ngIf="selectedProblemId as pid">
        <div class="section-header">
          <div>
            <h2 class="title text-1line">{{ 'issue.listTitle' | translate }}</h2>
            <p class="section-subtitle text-2line">課題とリンク、タスクをまとめて管理します。</p>
          </div>
        </div>

        <div class="section-body">
          <form class="inline-form" *ngIf="members.isEditor$ | async" (ngSubmit)="createIssue(pid)">
            <input [(ngModel)]="issueTitle" name="issueTitle" [placeholder]="'issue.placeholderNewTitle' | translate" required (ngModelChange)="onIssueTitleChange($event)" />
            <button mat-raised-button color="primary" type="submit" [disabled]="!(canEdit$ | async)">＋ {{ 'issue.add' | translate }}</button>
          </form>

          <ng-container *ngIf="issues$ | async as issues; else loadingIssues">
            <div class="issue-list" *ngIf="issues.length > 0; else emptyIssues">
              <article class="issue-item" *ngFor="let i of issues">
                <header class="issue-header">
                  <h3 class="title text-1line">{{ i.title }}</h3>
                  <div class="issue-actions" *ngIf="members.isEditor$ | async">
                    <button mat-stroked-button type="button" (click)="renameIssue(pid, i)" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                    <button mat-stroked-button color="warn" type="button" (click)="removeIssue(pid, i)" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                  </div>
                </header>

                <section class="issue-links">
                    <h4 class="title text-1line">{{ 'link.title' | translate }}</h4>
                  <div class="link-chips" *ngIf="visibleLinks(i.links, issues).length > 0; else noLinks">
                    <mat-chip-set>
                      <mat-chip *ngFor="let lk of visibleLinks(i.links, issues)" appearance="outlined">
                        <span class="link-type">[{{ linkLabel(lk.type) }}]</span>
                        <span class="link-target">{{ titleByIssueId(issues, lk.issueId) }}</span>
                        <button mat-icon-button type="button" *ngIf="members.isEditor$ | async" aria-label="{{ 'link.removeAria' | translate }}" (click)="onRemoveLink(pid, i.id!, lk.issueId, lk.type)" [disabled]="!(canEdit$ | async)">
                          <mat-icon fontIcon="close"></mat-icon>
                        </button>
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                  <ng-template #noLinks>
                    <div class="empty-state">{{ 'link.none' | translate }}</div>
                  </ng-template>

                  <form class="inline-form inline-form--compact" *ngIf="members.isEditor$ | async" (ngSubmit)="onAddLink(pid, i.id!)">
                    <select [(ngModel)]="linkTarget[i.id!]" name="linkTarget-{{ i.id }}">
                      <option [ngValue]="null">{{ 'link.selectIssuePrompt' | translate }}</option>
                      <option *ngFor="let j of issues" [ngValue]="j.id" [disabled]="j.id === i.id">{{ j.title }}</option>
                    </select>
                    <select [(ngModel)]="linkTypeSel[i.id!]" name="linkType-{{ i.id }}">
                      <option *ngFor="let t of linkTypes" [ngValue]="t">{{ linkLabel(t) }}</option>
                    </select>
                    <button mat-stroked-button type="submit" [disabled]="!(canEdit$ | async)">＋ {{ 'link.add' | translate }}</button>
                  </form>
                </section>

                <section class="issue-tasks">
                  <header class="tasks-header">
                    <h4 class="title text-1line">タスク</h4>
                  </header>
                  <form class="inline-form inline-form--compact" *ngIf="members.isEditor$ | async" (ngSubmit)="createTask(pid, i.id!)">
                    <input [(ngModel)]="taskTitle[i.id!]" name="taskTitle-{{ i.id }}" [placeholder]="'task.placeholderNewTitle' | translate" required (ngModelChange)="onTaskTitleChange(i.id!, taskTitle[i.id!])" />
                    <button mat-stroked-button type="submit" [disabled]="!(canEdit$ | async)">＋ {{ 'task.add' | translate }}</button>
                  </form>
                  <ul class="task-list" *ngIf="tasksMap[i.id!] | async as tasks">
                    <li *ngFor="let t of tasks" class="task-item">
                      <div class="task-main">
                        <span class="task-title text-1line">{{ t.title }}</span>
                        <span class="task-meta" *ngIf="t.dueDate">{{ 'task.dueShort' | translate:{ date: t.dueDate } }}</span>
                        <span class="task-tags">
                          <ng-container *ngIf="(t.tags?.length ?? 0) > 0; else noTags">
                            #{{ t.tags!.join(' #') }}
                          </ng-container>
                          <ng-template #noTags>{{ 'tag.none' | translate }}</ng-template>
                        </span>
                      </div>
                      <div class="task-actions" *ngIf="members.isEditor$ | async">
                        <button mat-button type="button" (click)="renameTask(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                        <button mat-button type="button" (click)="editTaskDue(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'task.editDue' | translate }}</button>
                        <button mat-button type="button" (click)="editTaskTags(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'task.editTags' | translate }}</button>
                        <button mat-button color="warn" type="button" (click)="removeTask(pid, i.id!, t)" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                      </div>
                    </li>
                    <li class="empty-state" *ngIf="tasks.length === 0">{{ 'task.noneYet' | translate }}</li>
                  </ul>
                </section>
              </article>
            </div>
            <ng-template #emptyIssues>
              <div class="empty-state">{{ 'issue.noneYet' | translate }}</div>
            </ng-template>
          </ng-container>
          <ng-template #loadingIssues>
            <div class="empty-state">{{ 'issue.loading' | translate }}</div>
          </ng-template>
        </div>
      </mat-card>

      <mat-card class="card section-card invite-card" *ngIf="(members.isAdmin$ | async)">
        <div class="section-header">
          <div>
            <h2>{{ 'invite.byEmailTitle' | translate }}</h2>
            <p class="section-subtitle">メールでチームメンバーを招待します。</p>
          </div>
        </div>
        <div class="section-body">
          <form class="inline-form invite-form" (ngSubmit)="$event.preventDefault()">
            <input [(ngModel)]="inviteEmail" name="inviteEmail" placeholder="email@example.com" />
            <select [(ngModel)]="inviteRole" name="inviteRole">
              <option value="admin">{{ 'role.adminLabel' | translate }}</option>
              <option value="member" selected>{{ 'role.memberLabel' | translate }}</option>
              <option value="viewer">{{ 'role.viewerLabel' | translate }}</option>
            </select>
            <button mat-raised-button color="primary" type="button" (click)="createInvite()" [disabled]="isCreatingInvite || !(isOnline$ | async)">
              {{ isCreatingInvite ? ('common.creating' | translate) : ('invite.createLink' | translate) }}
            </button>
          </form>
          <div class="invite-result" *ngIf="inviteUrl">
            <input [value]="inviteUrl" readonly />
            <button mat-stroked-button type="button" (click)="copyInviteUrl()">{{ 'common.copy' | translate }}</button>
          </div>
          <p class="muted">{{ 'invite.helpText' | translate }}</p>
        </div>
      </mat-card>

      <mat-card class="card section-card prefs-card">
        <div class="section-header">
          <div>
            <h2>{{ 'settings.titlePreview' | translate }}</h2>
            <p class="section-subtitle">{{ 'settings.lead' | translate }}</p>
          </div>
        </div>
        <div class="section-body">
          <pre>{{ (prefs.prefs$ | async) | json }}</pre>
        </div>
      </mat-card>

      <div class="settings-grid">
        <mat-card class="card section-card">
          <div class="section-header">
            <div>
              <h2>{{ 'settings.languageTitle' | translate }}</h2>
            </div>
          </div>
          <div class="section-body">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'settings.languageSelect' | translate }}</mat-label>
              <mat-select [(ngModel)]="lang" (selectionChange)="onLangChange($event.value)">
                <mat-option value="ja">日本語</mat-option>
                <mat-option value="en">English</mat-option>
              </mat-select>
              <mat-icon matSuffix>expand_more</mat-icon>
            </mat-form-field>
          </div>
        </mat-card>

        <mat-card class="card section-card">
          <div class="section-header">
            <div>
              <h2>{{ 'settings.themeTitle' | translate }}</h2>
            </div>
          </div>
          <div class="section-body">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'settings.themeSelect' | translate }}</mat-label>
              <mat-select [(ngModel)]="themeMode" (selectionChange)="onThemeChange($event.value)">
                <mat-option value="light">{{ 'theme.light' | translate }}</mat-option>
                <mat-option value="dark">{{ 'theme.dark' | translate }}</mat-option>
                <mat-option value="system">{{ 'theme.system' | translate }}</mat-option>
              </mat-select>
              <mat-icon matSuffix>expand_more</mat-icon>
            </mat-form-field>
          </div>
        </mat-card>
      </div>
    </div>

    <div class="overlay" *ngIf="newProblemOpen">
      <div class="dialog">
        <header class="dialog-header">
          <h3>{{ 'problem.create' | translate }}</h3>
          <button mat-icon-button type="button" (click)="closeNewProblemDialog()"><mat-icon>close</mat-icon></button>
        </header>
        <div class="dialog-body">
          <label>
            <span>{{ 'field.titleRequired' | translate }}</span>
            <input [(ngModel)]="newProblem.title" (ngModelChange)="onNewProblemChange('title', newProblem.title)" />
          </label>
          <label class="inline">
            <span>{{ 'field.template' | translate }}</span>
            <select [(ngModel)]="newProblem.template" (ngModelChange)="applyProblemTemplate($event); onNewProblemChange('template', newProblem.template)">
              <option value="bug">{{ 'template.bug' | translate }}</option>
              <option value="improve">{{ 'template.improve' | translate }}</option>
            </select>
          </label>
          <label>
            <span>{{ 'problem.phenomenonRequired' | translate }}</span>
            <textarea rows="3" [(ngModel)]="newProblem.phenomenon" (ngModelChange)="onNewProblemChange('phenomenon', newProblem.phenomenon)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.causeOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="newProblem.cause" (ngModelChange)="onNewProblemChange('cause', newProblem.cause)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.solutionOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="newProblem.solution" (ngModelChange)="onNewProblemChange('solution', newProblem.solution)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.goalRequired' | translate }}</span>
            <textarea rows="2" [(ngModel)]="newProblem.goal" (ngModelChange)="onNewProblemChange('goal', newProblem.goal)"></textarea>
            <small>{{ 'hint.goalKpi' | translate }}</small>
          </label>
        </div>
        <footer class="dialog-footer">
          <button mat-stroked-button type="button" (click)="closeNewProblemDialog()">{{ 'common.cancel' | translate }}</button>
          <button mat-raised-button color="primary" type="button" (click)="createProblemWithDefinition()" [disabled]="!(canEdit$ | async)">{{ 'common.create' | translate }}</button>
        </footer>
      </div>
    </div>

    <div class="overlay" *ngIf="editProblemOpen">
      <div class="dialog">
        <header class="dialog-header">
          <h3>{{ 'problemDef.edit' | translate }}</h3>
          <button mat-icon-button type="button" (click)="closeEditProblemDialog()"><mat-icon>close</mat-icon></button>
        </header>
        <div class="dialog-body">
          <label>
            <span>{{ 'field.titleReadonly' | translate }}</span>
            <input [value]="editProblem.title" readonly />
          </label>
          <label>
            <span>{{ 'problem.phenomenonRequired' | translate }}</span>
            <textarea rows="3" [(ngModel)]="editProblem.phenomenon" (ngModelChange)="onEditProblemChange('phenomenon', editProblem.phenomenon)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.causeOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="editProblem.cause" (ngModelChange)="onEditProblemChange('cause', editProblem.cause)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.solutionOptional' | translate }}</span>
            <textarea rows="3" [(ngModel)]="editProblem.solution" (ngModelChange)="onEditProblemChange('solution', editProblem.solution)"></textarea>
          </label>
          <label>
            <span>{{ 'problem.goalRequired' | translate }}</span>
            <textarea rows="2" [(ngModel)]="editProblem.goal" (ngModelChange)="onEditProblemChange('goal', editProblem.goal)"></textarea>
          </label>
        </div>
        <footer class="dialog-footer">
          <button mat-stroked-button type="button" (click)="closeEditProblemDialog()">{{ 'common.cancel' | translate }}</button>
          <button mat-raised-button color="primary" type="button" (click)="saveEditedProblemDef()" [disabled]="!(canEdit$ | async)">{{ 'common.save' | translate }}</button>
        </footer>
      </div>
    </div>
  </ng-container>

  <ng-template #guestState>
    <mat-card class="card guest-card">
      <h2>{{ 'home.needSignIn' | translate }}</h2>
      <p>{{ 'home.viewOnlyHint' | translate }}</p>
      <p class="muted">
        (<a routerLink="/tree">{{ 'nav.tree' | translate }}</a> /
        <a routerLink="/board">{{ 'nav.board' | translate }}</a> /
        <a routerLink="/schedule">{{ 'nav.schedule' | translate }}</a>)
      </p>
    </mat-card>
  </ng-template>
</section>
