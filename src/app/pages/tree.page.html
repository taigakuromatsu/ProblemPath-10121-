<section class="tree-page">
  <header class="page-header">
    <div class="page-titles">
      <h1 class="section-title section-title--info no-truncate">{{ 'tree.title' | translate }}</h1>
      <p class="page-subtitle text-2line">èª²é¡Œã®æ§‹é€ ã¨é€²æ—ã‚’ä¸€è¦§ã§ãã¾ã™ã€‚</p>
    </div>
  </header>

  <div class="kpi-grid" *ngIf="dash$ | async as d">
    <article class="kpi-card" aria-label="å…¨ä½“ã®é€²æ—">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">ğŸ“ˆ</span>
        <span class="kpi-card__title">å…¨ä½“ã®é€²æ—</span>
      </div>
      <p class="kpi-card__value">{{ d.progressPct }}<span class="unit">%</span></p>
      <p class="kpi-card__meta">{{ d.doneTotal }} / {{ d.openTotal + d.doneTotal }} å®Œäº†</p>
    </article>
    <article class="kpi-card" aria-label="æœªå®Œäº†ã‚¿ã‚¹ã‚¯æ•°">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">ğŸ—‚ï¸</span>
        <span class="kpi-card__title">æœªå®Œäº†ã‚¿ã‚¹ã‚¯æ•°</span>
      </div>
      <p class="kpi-card__value">{{ d.openTotal }}</p>
      <p class="kpi-card__meta">æœªå®Œäº†</p>
    </article>
    <article class="kpi-card" aria-label="ä»Šé€±æœŸé™">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">â°</span>
        <span class="kpi-card__title">ä»Šé€±æœŸé™</span>
      </div>
      <p class="kpi-card__value">{{ d.today + d.thisWeek }}</p>
      <p class="kpi-card__meta">ä»Šæ—¥ {{ d.today }} / ä»Šé€± {{ d.thisWeek }}</p>
    </article>
    <article class="kpi-card" aria-label="æœŸé™åˆ‡ã‚Œ">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">âš ï¸</span>
        <span class="kpi-card__title">æœŸé™åˆ‡ã‚Œ</span>
      </div>
      <p class="kpi-card__value warning">{{ d.overdue }}</p>
      <p class="kpi-card__meta">æœŸé™åˆ‡ã‚Œ {{ d.overdue }}</p>
    </article>
  </div>

  <div class="tree-workspace">
    <div class="tree-layout">
      <mat-card class="tree-panel card-surface">
        <div class="panel-header sticky-header">
          <h2 class="section-title section-title--info no-truncate">èª²é¡Œãƒ„ãƒªãƒ¼</h2>
          <button mat-stroked-button color="primary" type="button" (click)="retryProblems()" *ngIf="loadError">
            {{ 'common.retry' | translate }}
          </button>
        </div>

        <div class="error-banner" *ngIf="loadError">{{ loadError }}</div>

        <div class="tree-scroll">
          <mat-tree [dataSource]="dataSource" [treeControl]="tree" class="status-tree">
            <mat-nested-tree-node *matTreeNodeDef="let node; when: isProblem">
              <div class="node-card node-card--problem" [class.is-selected]="selectedNode?.id === node.id">
                <span class="node-line" aria-hidden="true"></span>
                <div class="node-row node-row--problem">
                  <button mat-icon-button matTreeNodeToggle [disabled]="!(node.children?.length)">
                    <mat-icon>{{ tree.isExpanded(node) ? 'expand_more' : 'chevron_right' }}</mat-icon>
                  </button>
                  <div class="node-main">
                    <span class="node-title" [attr.aria-label]="node.name">{{ node.name }}</span>
                  </div>
                  <div class="node-chips">
                    <button mat-stroked-button type="button" class="chip-button" (click)="openComments(node)">
                      ğŸ’¬ {{ 'cf.count' | translate:{ c: (commentCounts[node.id] ?? 0), f: (attachmentCounts[node.id] ?? 0) } }}
                    </button>
                    <button mat-button type="button" (click)="renameProblemNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                    <button mat-button type="button" color="warn" (click)="removeProblemNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                  </div>
                </div>
                <div class="node-children" *ngIf="tree.isExpanded(node)">
                  <ng-container matTreeNodeOutlet></ng-container>
                </div>
              </div>
            </mat-nested-tree-node>

            <mat-nested-tree-node *matTreeNodeDef="let node; when: isIssue">
              <div class="node-card node-card--issue" [class.is-selected]="selectedNode?.id === node.id">
                <span class="node-line" aria-hidden="true"></span>
                <div class="node-row node-row--issue">
                  <button mat-icon-button matTreeNodeToggle [disabled]="!(node.children?.length)">
                    <mat-icon>{{ tree.isExpanded(node) ? 'expand_more' : 'chevron_right' }}</mat-icon>
                  </button>
                  <div class="node-main">
                    <span class="node-title" [attr.aria-label]="node.name">{{ node.name }}</span>
                  </div>
                  <div class="node-chips">
                    <button mat-stroked-button type="button" class="chip-button" (click)="openComments(node)">
                      ğŸ’¬ {{ 'cf.count' | translate:{ c: (commentCounts[node.id] ?? 0), f: (attachmentCounts[node.id] ?? 0) } }}
                    </button>
                    <button mat-button type="button" (click)="renameIssueNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                    <button mat-button type="button" color="warn" (click)="removeIssueNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                  </div>
                </div>
                <div class="node-children" *ngIf="tree.isExpanded(node)">
                  <ng-container matTreeNodeOutlet></ng-container>
                </div>
              </div>
            </mat-nested-tree-node>

            <mat-nested-tree-node *matTreeNodeDef="let node">
              <div class="node-card node-card--task" [class.is-selected]="selectedNode?.id === node.id">
                <span class="node-line" aria-hidden="true"></span>
                <div class="node-row node-row--task">
                  <div class="node-main">
                    <span class="node-title" [matTooltip]="node.name" [attr.aria-label]="node.name">{{ node.name }}</span>
                  </div>
                  <div class="node-meta">
                    <ng-container *ngIf="findColumnForTask(node.task) as col; else fallbackColumn">
                      <span
                        class="task-status-pill"
                        [ngClass]="statusClassForColumn(col)"
                        [matTooltip]="tooltipForColumn(col)">
                        {{ col.title }}
                      </span>
                    </ng-container>
                    <ng-template #fallbackColumn>
                      <span
                        class="task-status-pill"
                        [ngClass]="statusClassForColumn()"
                        [matTooltip]="tooltipForColumn()">
                        â€”
                      </span>
                    </ng-template>
                  </div>
                  <div class="node-chips">
                    <button mat-stroked-button type="button" class="chip-button" (click)="openComments(node)">
                      ğŸ’¬ {{ 'cf.count' | translate:{ c: (commentCounts[node.id] ?? 0), f: (attachmentCounts[node.id] ?? 0) } }}
                    </button>
                    <button mat-button type="button" (click)="renameTaskNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                    <button mat-button type="button" color="warn" (click)="removeTaskNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                  </div>
                </div>
              </div>
            </mat-nested-tree-node>
          </mat-tree>
        </div>
      </mat-card>

      <aside class="detail-panel card-surface">
        <ng-container *ngIf="selectedNode; else emptyDetail">
          <div class="detail-panel__content">
            <header class="detail-header">
              <div class="detail-title-group">
                <h2 class="detail-title no-truncate">{{ selectedNode.name }}</h2>
                <p class="detail-subtitle">{{ 'cf.header' | translate:{ kind: selectedNode.kind, name: selectedNode.name } }}</p>
              </div>
              <div class="detail-tabs" role="tablist" aria-label="ã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿">
                <button
                  type="button"
                  class="detail-tab"
                  role="tab"
                  [class.is-active]="activeDetailTab === 'comments'"
                  [attr.aria-selected]="activeDetailTab === 'comments'"
                  [attr.tabindex]="activeDetailTab === 'comments' ? 0 : -1"
                  (click)="activeDetailTab = 'comments'">
                  ã‚³ãƒ¡ãƒ³ãƒˆ
                </button>
                <button
                  type="button"
                  class="detail-tab"
                  role="tab"
                  [class.is-active]="activeDetailTab === 'files'"
                  [attr.aria-selected]="activeDetailTab === 'files'"
                  [attr.tabindex]="activeDetailTab === 'files' ? 0 : -1"
                  (click)="activeDetailTab = 'files'">
                  ãƒ•ã‚¡ã‚¤ãƒ«
                </button>
              </div>
            </header>

            <div class="detail-scroll" [ngSwitch]="activeDetailTab">
              <div class="detail-pane detail-pane--comments" *ngSwitchCase="'comments'">
                <div class="alert-inline" *ngIf="!(isOnline$ | async)">{{ 'warn.offlineComments' | translate }}</div>

                <div class="comment-editor">
                  <textarea [(ngModel)]="newBody" (ngModelChange)="onCommentBodyChange($event)" [disabled]="!(canEdit$ | async)" rows="3" [placeholder]="'comment.placeholder' | translate"></textarea>
                  <div class="editor-actions">
                    <button mat-raised-button color="primary" type="button" (click)="editingId ? saveEdit() : addComment()" [disabled]="!newBody.trim() || !(canEdit$ | async)">
                      {{ editingId ? ('comment.update' | translate) : ('comment.post' | translate) }}
                    </button>
                    <button mat-stroked-button type="button" (click)="cancelEdit()" *ngIf="editingId">{{ 'common.cancel' | translate }}</button>
                  </div>
                </div>

                <section class="comment-list" *ngIf="comments$ | async as cs; else loadingComments">
                  <div class="empty-state" *ngIf="!cs.length">{{ 'comment.noneYet' | translate }}</div>
                  <article class="comment-item" *ngFor="let c of cs">
                    <header>
                      <span class="author">{{ c.authorName || c.authorId }}</span>
                      <span class="timestamp">{{ c.createdAt?.toDate?.() ? (c.createdAt.toDate() | date:'yyyy/MM/dd HH:mm') : '' }}</span>
                    </header>
                    <div class="body">{{ c.body }}</div>
                    <div class="comment-actions" *ngIf="(members.isAdmin$ | async) || ((auth.uid$ | async) === c.authorId)">
                      <button mat-button type="button" (click)="startEdit(c.id!, c.body)" [disabled]="!(canEdit$ | async)">{{ 'common.edit' | translate }}</button>
                      <button mat-button type="button" color="warn" (click)="deleteComment(c.id!)" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                    </div>
                  </article>
                </section>
                <ng-template #loadingComments>
                  <div class="empty-state">{{ 'common.loading' | translate }}</div>
                </ng-template>
              </div>

              <div class="detail-pane detail-pane--files" *ngSwitchCase="'files'">
                <section class="attachments">
                  <h3>ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                  <div class="upload-bar">
                    <input type="file" multiple accept="image/*,.pdf" (change)="onPickFiles($event)" [disabled]="uploadBusy || !(canEdit$ | async)" />
                    <span class="muted" *ngIf="uploadBusy">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦</span>
                  </div>

                  <div class="attachment-list" *ngIf="attachments$ | async as ats; else loadingAttachments">
                    <div class="empty-state" *ngIf="!ats.length">ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>
                    <div class="attachment-item" *ngFor="let a of ats">
                      <div class="thumb">
                        <img *ngIf="a.downloadURL && a.contentType?.startsWith('image/')" [src]="a.downloadURL" alt="" />
                        <span *ngIf="!a.contentType?.startsWith('image/')">ğŸ“„</span>
                      </div>
                      <div class="details">
                        <div class="name text-1line no-truncate">{{ a.name }}</div>
                        <div class="meta">{{ a.contentType || 'binary' }} ãƒ» {{ a.size | number }} bytes</div>
                      </div>
                      <div class="attachment-actions">
                        <a *ngIf="a.downloadURL" mat-stroked-button [href]="a.downloadURL" target="_blank" rel="noopener">é–‹ã</a>
                        <button mat-button color="warn" type="button" (click)="removeAttachment(a)" [disabled]="!(canEdit$ | async)">å‰Šé™¤</button>
                      </div>
                    </div>
                  </div>
                  <ng-template #loadingAttachments>
                    <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
                  </ng-template>
                </section>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #emptyDetail>
          <div class="detail-empty">{{ 'comment.emptyHint' | translate }}</div>
        </ng-template>
      </aside>
    </div>
  </div>
</section>

