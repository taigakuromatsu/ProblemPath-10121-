<section class="tree-page">
  <header class="page-header">
    <div class="page-titles">
      <h1 class="section-title section-title--info no-truncate">{{ 'tree.title' | translate }}</h1>
      <p class="page-subtitle text-2line">{{ 'tree.subtitle' | translate }}</p>
    </div>
  </header>

  <div class="kpi-grid" *ngIf="dash$ | async as d">
    <article class="kpi-card" aria-label="overall">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">üìà</span>
        <span class="kpi-card__title">{{ 'tree.kpi.overall' | translate }}</span>
      </div>
      <p class="kpi-card__value">{{ d.progressPct }}<span class="unit">%</span></p>
      <p class="kpi-card__meta">
        {{ 'tree.kpi.overallMeta' | translate:{ done: d.doneTotal, total: (d.openTotal + d.doneTotal) } }}
      </p>
    </article>
    
    <article class="kpi-card" aria-label="open">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">üóÇÔ∏è</span>
        <span class="kpi-card__title">{{ 'tree.kpi.open' | translate }}</span>
      </div>
      <p class="kpi-card__value">{{ d.openTotal }}</p>
      <p class="kpi-card__meta">{{ 'tree.open' | translate }}</p>
    </article>
    
    <article class="kpi-card" aria-label="thisWeek">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">‚è∞</span>
        <span class="kpi-card__title">{{ 'tree.kpi.thisWeek' | translate }}</span>
      </div>
      <p class="kpi-card__value">{{ d.today + d.thisWeek }}</p>
      <p class="kpi-card__meta">
        {{ 'tree.kpi.todayAndWeek' | translate:{ today: d.today, week: d.thisWeek } }}
      </p>
    </article>
    
    <article class="kpi-card" aria-label="overdue">
      <div class="kpi-card__header">
        <span class="kpi-card__icon" aria-hidden="true">‚ö†Ô∏è</span>
        <span class="kpi-card__title">{{ 'tree.kpi.overdue' | translate }}</span>
      </div>
      <p class="kpi-card__value warning">{{ d.overdue }}</p>
      <p class="kpi-card__meta">{{ 'tree.overdue' | translate }} {{ d.overdue }}</p>
    </article>
  </div>

  <div class="tree-workspace">
    <div class="tree-layout">
      <mat-card class="tree-panel card-surface">
        <div class="panel-header sticky-header">
          <h2 class="section-title section-title--info no-truncate">{{ 'tree.treeTitle' | translate }}</h2>
          <button mat-stroked-button color="primary" type="button" (click)="retryProblems()" *ngIf="loadError">
            {{ 'common.retry' | translate }}
          </button>
        </div>

        <div class="error-banner" *ngIf="loadError">{{ loadError }}</div>

        <div class="tree-scroll">
          <mat-tree [dataSource]="dataSource" [treeControl]="tree" class="status-tree">
            <mat-nested-tree-node *matTreeNodeDef="let node; when: isProblem">
              <div class="node-card node-card--problem" [class.is-selected]="selectedNode?.id === node.id">
                <span class="node-line" aria-hidden="true"></span>
                <div class="node-row node-row--problem">
                  <button mat-icon-button matTreeNodeToggle [disabled]="!(node.children?.length)">
                    <mat-icon>{{ tree.isExpanded(node) ? 'expand_more' : 'chevron_right' }}</mat-icon>
                  </button>
                  <div class="node-main">
                    <span class="node-title" [attr.aria-label]="node.name">{{ node.name }}</span>
                  </div>
                  <div class="node-chips">
                    <button mat-stroked-button type="button" class="chip-button" (click)="openComments(node)">
                      üí¨ {{ 'cf.count' | translate:{ c: (commentCounts[node.id] ?? 0), f: (attachmentCounts[node.id] ?? 0) } }}
                    </button>
                    <button mat-button type="button" (click)="renameProblemNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                    <button mat-button type="button" color="warn" (click)="removeProblemNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                  </div>
                </div>
                <div class="node-children" *ngIf="tree.isExpanded(node)">
                  <ng-container matTreeNodeOutlet></ng-container>
                </div>
              </div>
            </mat-nested-tree-node>

            <mat-nested-tree-node *matTreeNodeDef="let node; when: isIssue">
              <div class="node-card node-card--issue" [class.is-selected]="selectedNode?.id === node.id">
                <span class="node-line" aria-hidden="true"></span>
                <div class="node-row node-row--issue">
                  <button mat-icon-button matTreeNodeToggle [disabled]="!(node.children?.length)">
                    <mat-icon>{{ tree.isExpanded(node) ? 'expand_more' : 'chevron_right' }}</mat-icon>
                  </button>
                  <div class="node-main">
                    <span class="node-title" [attr.aria-label]="node.name">{{ node.name }}</span>
                  </div>
                  <div class="node-chips">
                    <button mat-stroked-button type="button" class="chip-button" (click)="openComments(node)">
                      üí¨ {{ 'cf.count' | translate:{ c: (commentCounts[node.id] ?? 0), f: (attachmentCounts[node.id] ?? 0) } }}
                    </button>
                    <button mat-button type="button" (click)="renameIssueNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                    <button mat-button type="button" color="warn" (click)="removeIssueNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                  </div>
                </div>
                <div class="node-children" *ngIf="tree.isExpanded(node)">
                  <ng-container matTreeNodeOutlet></ng-container>
                </div>
              </div>
            </mat-nested-tree-node>

            <mat-nested-tree-node *matTreeNodeDef="let node">
              <div class="node-card node-card--task" [class.is-selected]="selectedNode?.id === node.id">
                <span class="node-line" aria-hidden="true"></span>
                <div class="node-row node-row--task">
                  <div class="node-main">
                    <span class="node-title" [matTooltip]="node.name" [attr.aria-label]="node.name">{{ node.name }}</span>
                  </div>
                  <div class="node-meta">
                    <ng-container *ngIf="findColumnForTask(node.task) as col; else fallbackColumn">
                      <span
                        class="task-status-pill"
                        [ngClass]="statusClassForColumn(col)"
                        [matTooltip]="tooltipForColumn(col)">
                        {{ col.title }}
                      </span>
                    </ng-container>
                    <ng-template #fallbackColumn>
                      <span
                        class="task-status-pill"
                        [ngClass]="statusClassForColumn()"
                        [matTooltip]="tooltipForColumn()">
                        ‚Äî
                      </span>
                    </ng-template>

                      <!-- ‚ñº ËøΩÂä†: ÂÑ™ÂÖàÂ∫¶„ÅÆË°®Á§∫ÔºÜÂ§âÊõ¥Ôºà„É°„Éã„É•„ÉºÔºâ -->
                      <button
                        mat-stroked-button
                        type="button"
                        class="chip-button chip-priority"
                        [matMenuTriggerFor]="priorityMenu"
                        [disabled]="isBusyId(node.id) || !(canEdit$ | async)"
                        *ngIf="node.task"
                        [attr.aria-label]="'priority.changeAria' | translate"
                      >
                        <mat-icon>flag</mat-icon>
                        <span>
                          {{ (node.task?.priority ? ('priority.' + node.task.priority) : 'common.none') | translate }}
                        </span>
                        <mat-icon>arrow_drop_down</mat-icon>
                      </button>

                      <!-- „Åì„ÅÆ„É°„Éã„É•„Éº„ÅØÂêÑ„Çø„Çπ„ÇØË°å„Åî„Å®„Å´„Ç§„É≥„Çπ„Çø„É≥„ÇπÂåñ„Åï„Çå„Åæ„Åô -->
                      <mat-menu #priorityMenu="matMenu">
                        <button mat-menu-item (click)="setTaskPriority(node, 'high')" [disabled]="isBusyId(node.id) || !(canEdit$ | async)">
                          <mat-icon>priority_high</mat-icon>
                          <span>{{ 'priority.high' | translate }}</span>
                        </button>
                        <button mat-menu-item (click)="setTaskPriority(node, 'mid')" [disabled]="isBusyId(node.id) || !(canEdit$ | async)">
                          <mat-icon>flag</mat-icon>
                          <span>{{ 'priority.mid' | translate }}</span>
                        </button>
                        <button mat-menu-item (click)="setTaskPriority(node, 'low')" [disabled]="isBusyId(node.id) || !(canEdit$ | async)">
                          <mat-icon>south</mat-icon>
                          <span>{{ 'priority.low' | translate }}</span>
                        </button>
                      </mat-menu>
                  </div>
                  <div class="node-chips">
                    <button mat-stroked-button type="button" class="chip-button" (click)="openComments(node)">
                      üí¨ {{ 'cf.count' | translate:{ c: (commentCounts[node.id] ?? 0), f: (attachmentCounts[node.id] ?? 0) } }}
                    </button>
                    <button mat-button type="button" (click)="renameTaskNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.rename' | translate }}</button>
                    <button mat-button type="button" color="warn" (click)="removeTaskNode(node)" *ngIf="isEditor$ | async" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                  </div>
                </div>
              </div>
            </mat-nested-tree-node>
          </mat-tree>
        </div>
      </mat-card>

      <aside class="detail-panel card-surface">
        <ng-container *ngIf="selectedNode; else emptyDetail">
          <div class="detail-panel__content">
            <header class="detail-header">
              <div class="detail-title-group">
                <h2 class="detail-title no-truncate">{{ selectedNode.name }}</h2>
                <p class="detail-subtitle">{{ 'cf.header' | translate:{ kind: selectedNode.kind, name: selectedNode.name } }}</p>
              </div>
              <div class="detail-tabs" role="tablist" aria-label="„Ç≥„É°„É≥„Éà„Å®„Éï„Ç°„Ç§„É´„ÅÆË°®Á§∫ÂàáÊõø">
                <button
                  type="button"
                  class="detail-tab"
                  role="tab"
                  [class.is-active]="activeDetailTab === 'comments'"
                  [attr.aria-selected]="activeDetailTab === 'comments'"
                  [attr.tabindex]="activeDetailTab === 'comments' ? 0 : -1"
                  (click)="activeDetailTab = 'comments'">
                  {{ 'comment.title' | translate }}
                </button>
                <button
                  type="button"
                  class="detail-tab"
                  role="tab"
                  [class.is-active]="activeDetailTab === 'files'"
                  [attr.aria-selected]="activeDetailTab === 'files'"
                  [attr.tabindex]="activeDetailTab === 'files' ? 0 : -1"
                  (click)="activeDetailTab = 'files'">
                  {{ 'files.title' | translate }}
                </button>
              </div>
            </header>

            <div class="detail-scroll" [ngSwitch]="activeDetailTab">
              <div class="detail-pane detail-pane--comments" *ngSwitchCase="'comments'">
                <div class="alert-inline" *ngIf="!(isOnline$ | async)">{{ 'warn.offlineComments' | translate }}</div>

                <div class="comment-editor">
                  <textarea [(ngModel)]="newBody" (ngModelChange)="onCommentBodyChange($event)" [disabled]="!(canEdit$ | async)" rows="3" [placeholder]="'comment.placeholder' | translate"></textarea>
                  <div class="editor-actions">
                    <button mat-raised-button color="primary" type="button" (click)="editingId ? saveEdit() : addComment()" [disabled]="!newBody.trim() || !(canEdit$ | async)">
                      {{ editingId ? ('comment.update' | translate) : ('comment.post' | translate) }}
                    </button>
                    <button mat-stroked-button type="button" (click)="cancelEdit()" *ngIf="editingId">{{ 'common.cancel' | translate }}</button>
                  </div>
                </div>

                <section class="comment-list" *ngIf="comments$ | async as cs; else loadingComments">
                  <div class="empty-state" *ngIf="!cs.length">{{ 'comment.noneYet' | translate }}</div>
                  <article class="comment-item" *ngFor="let c of cs">
                    <header>
                      <span class="author">{{ c.authorName || c.authorId }}</span>
                      <span class="timestamp">{{ c.createdAt?.toDate?.() ? (c.createdAt.toDate() | date:'yyyy/MM/dd HH:mm') : '' }}</span>
                    </header>
                    <div class="body">{{ c.body }}</div>
                    <div class="comment-actions" *ngIf="(members.isAdmin$ | async) || ((auth.uid$ | async) === c.authorId)">
                      <button mat-button type="button" (click)="startEdit(c.id!, c.body)" [disabled]="!(canEdit$ | async)">{{ 'common.edit' | translate }}</button>
                      <button mat-button type="button" color="warn" (click)="deleteComment(c.id!)" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                    </div>
                  </article>
                </section>
                <ng-template #loadingComments>
                  <div class="empty-state">{{ 'common.loading' | translate }}</div>
                </ng-template>
              </div>

              <div class="detail-pane detail-pane--files" *ngSwitchCase="'files'">
                <section class="attachments">
                  <h3>üìé {{ 'files.title' | translate }}</h3>
                  <div class="upload-bar">
                    <label class="filepick"
                          [class.is-disabled]="uploadBusy || !(canEdit$ | async)"
                          [attr.aria-disabled]="uploadBusy || !(canEdit$ | async) ? 'true' : null">
                      <!-- „Éç„Ç§„ÉÜ„Ç£„Éñ input „ÅØË¶ñË¶öÁöÑ„Å´Èö†„Åô -->
                      <input
                        type="file"
                        #fileInput
                        multiple
                        accept="image/*,.pdf"
                        (change)="rememberPickedNames($event); onPickFiles($event)"
                        [disabled]="uploadBusy || !(canEdit$ | async)"
                      />
                      <!-- Áñë‰ºº„Éú„Çø„É≥Ôºö„Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú„ÇÇÂèØ„Å´„Åô„Çã -->
                      <span class="filepick__btn"
                            tabindex="0"
                            (keydown.enter)="fileInput.click()"
                            (keydown.space)="fileInput.click(); $event.preventDefault()"
                            [attr.aria-label]="'files.pick' | translate">
                        {{ 'files.pick' | translate }}
                      </span>
                    </label>
                  
                    <!-- ÈÅ∏Êäû„Éï„Ç°„Ç§„É´ÂêçÔºàÂÖàÈ†≠ + ‰ª∂Êï∞Ôºâ„Çí‰ªªÊÑèË°®Á§∫ -->
                    <span class="filepick__note" *ngIf="lastPickedNames?.length">
                      {{ lastPickedNames[0] }}<ng-container *ngIf="lastPickedNames.length > 1">
                        &nbsp;+{{ lastPickedNames.length - 1 }}
                      </ng-container>
                    </span>
                  
                    <span class="muted" *ngIf="uploadBusy">{{ 'files.uploading' | translate }}</span>
                  </div>
                  

                  <div class="attachment-list" *ngIf="attachments$ | async as ats; else loadingAttachments">
                    <div class="empty-state" *ngIf="!ats.length">{{ 'common.none' | translate }}</div>
                    <div class="attachment-item" *ngFor="let a of ats">
                      <div class="attachment-actions">
                        <a *ngIf="a.downloadURL" mat-stroked-button [href]="a.downloadURL" target="_blank" rel="noopener">{{ 'files.open' | translate }}</a>
                        <button mat-button color="warn" type="button" (click)="removeAttachment(a)" [disabled]="!(canEdit$ | async)">{{ 'common.delete' | translate }}</button>
                      </div>
                    </div>
                  </div>
                  <ng-template #loadingAttachments>
                    <div class="empty-state">{{ 'common.loading' | translate }}</div>
                  </ng-template>
                </section>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #emptyDetail>
          <div class="detail-empty">{{ 'comment.emptyHint' | translate }}</div>
        </ng-template>
      </aside>
    </div>
  </div>
</section>

