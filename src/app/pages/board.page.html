<section class="board-page">
  <header class="board-header">
    <div class="header-left">
      <div class="title-block">
        <h1 class="section-title section-title--info no-truncate">{{ 'nav.board' | translate }}</h1>
        <p class="subtitle text-2line" *ngIf="!selectedProblemId">{{ 'board.selectProblemHint' | translate }}</p>
      </div>
      <div class="problem-select">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>{{ 'label.problem' | translate }}</mat-label>
          <mat-select
            [(ngModel)]="selectedProblemId"
            (ngModelChange)="onSelectProblem($event)"
            [disabled]="(problems$ | async)?.length === 0"
          >
            <mat-option [value]="null">{{ 'common.selectPrompt' | translate }}</mat-option>
            <mat-option *ngFor="let p of (problems$ | async)" [value]="p.id">{{ p.title }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div class="header-right">
      <button
        mat-stroked-button
        type="button"
        (click)="onAddColumn()"
        [disabled]="!(canEdit$ | async)"
      >
        <mat-icon>add</mat-icon>
        列を追加
      </button>
    </div>
  </header>

  <div class="status-banner" *ngIf="!(isOnline$ | async)">
    <mat-icon>signal_wifi_off</mat-icon>
    <span>{{ 'board.offlineNotice' | translate }}</span>
  </div>

  <mat-card class="board-hint">
    <mat-icon>info</mat-icon>
    <span>
      特に指定がない場合、タスクカードを置いた列の設定（ステータス / 進捗率）に従って、そのタスクの状態と進捗が自動的に決まります。
    </span>
  </mat-card>

  <ng-container *ngIf="selectedProblemId as pid">
    <div class="loading" *ngIf="(issues$ | async) === null">{{ 'issue.loading' | translate }}</div>

    <ng-container *ngIf="(issues$ | async) as issues">
      <div class="empty" *ngIf="!issues.length">{{ 'issue.noneYet' | translate }}</div>

      <div
        class="board-grid"
        *ngIf="issues.length"
        cdkDropList
        cdkDropListOrientation="horizontal"
        [cdkDropListData]="columns"
        (cdkDropListDropped)="onColumnDrop($event)"
        [cdkDropListDisabled]="!(canEdit$ | async)"
      >
        <section
          class="board-column"
          [ngClass]="col.columnId"
          *ngFor="let col of columns; trackBy: trackColumn"
          [style.--col-accent]="accentFor(col)"
          cdkDrag
          [cdkDragData]="col"
          [cdkDragDisabled]="!(canEdit$ | async)"
        >
          <header class="column-header" [ngClass]="col.columnId">
            <div class="column-header__main">
              <button
                mat-icon-button
                type="button"
                class="column-header__drag"
                cdkDragHandle
                [disabled]="!(canEdit$ | async)"
                aria-label="列を並べ替え"
              >
                <mat-icon>drag_indicator</mat-icon>
              </button>
              <div class="column-title text-1line no-truncate">{{ columnTitle(col) }}</div>
            </div>
            <div class="column-header__actions">
              <span class="column-count count-badge">{{ totalFor(col.columnId) }}</span>
              <button
                mat-icon-button
                type="button"
                (click)="onEditColumn(col)"
                [disabled]="!(canEdit$ | async)"
                aria-label="列を編集"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                type="button"
                (click)="onDeleteColumn(col)"
                [disabled]="!(canEdit$ | async)"
                aria-label="列を削除"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </header>

          <div class="column-body">
            <ng-container *ngFor="let issue of issues">
              <ng-container *ngIf="tasksMap[key(pid, issue.id!)] | async as tasks">
                <ng-container *ngIf="tasksForColumn(tasks, col) as ts">
                  <section
                    class="issue-stack"
                    cdkDropList
                    [cdkDropListData]="ts"
                    [cdkDropListConnectedTo]="listIds(issue.id!)"
                    [id]="listId(col, issue.id!)"
                    (cdkDropListDropped)="onListDrop($event, pid, issue.id!)"
                    [cdkDropListEnterPredicate]="canEnter"
                    [cdkDropListDisabled]="!(canEdit$ | async)"
                    cdkDropListOrientation="vertical"
                  >
                    <div class="issue-stack__header">
                      <div class="issue-title text-1line no-truncate">{{ issue.title }}</div>
                      <span class="issue-count count-badge">{{ ts.length }} {{ 'board.items' | translate }}</span>
                    </div>

                    <mat-card
                      class="task-card"
                      *ngFor="let t of ts; trackBy: trackTask"
                      cdkDrag
                      [cdkDragData]="{ task: t, issueId: issue.id }"
                      [cdkDragDisabled]="isBusy(t.id!) || !(canEdit$ | async)"
                      [class.task-card--disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                    >
                      <ng-template cdkDragPreview>
                        <mat-card class="task-card task-card--preview">
                          <div class="task-card__title text-1line no-truncate">{{ t.title }}</div>
                        </mat-card>
                      </ng-template>
                      <ng-template cdkDragPlaceholder>
                        <div class="task-card task-card--placeholder"></div>
                      </ng-template>

                      <div class="task-card__meta">
                        <span class="task-id" *ngIf="t.id">#{{ t.id.slice(0, 6) }}</span>
                        <span class="task-assignees" *ngIf="(t.assignees?.length || 0) > 0">
                          <mat-icon>group</mat-icon>
                          {{ t.assignees?.length || 0 }}
                        </span>
                      </div>

                      <div class="task-card__title text-1line no-truncate">{{ t.title }}</div>
                      <p class="task-card__description text-2line" *ngIf="t.description">{{ t.description }}</p>

                      <div class="task-card__chips">
                        <mat-chip-set>
                          <mat-chip appearance="outlined" class="chip chip-priority">
                            <mat-icon matChipAvatar>flag</mat-icon>
                            <span>{{ t.priority || ('common.none' | translate) }}</span>
                          </mat-chip>
                          <mat-chip appearance="outlined" class="chip chip-status">
                            <mat-icon matChipAvatar>timeline</mat-icon>
                            <span>{{ columnTitleByCategory(bucket(t.status)) }}</span>
                          </mat-chip>
                          <mat-chip appearance="outlined" class="chip chip-due">
                            <mat-icon matChipAvatar>event</mat-icon>
                            <ng-container *ngIf="t.dueDate; else noDue">
                              {{ t.dueDate | date:'yyyy/MM/dd' }}
                            </ng-container>
                            <ng-template #noDue>{{ 'common.none' | translate }}</ng-template>
                          </mat-chip>
                        </mat-chip-set>
                      </div>

                      <div class="task-card__actions" *ngIf="isEditor$ | async">
                        <button
                          mat-stroked-button
                          *ngFor="let next of columns; trackBy: trackColumn"
                          [disabled]="isTaskInColumn(t, next) || isBusy(t.id!) || !(canEdit$ | async)"
                          (click)="setTaskStatus(pid, issue.id!, t, next.columnId)"
                        >
                          {{ columnTitle(next) }}
                        </button>
                      </div>

                      <div class="task-card__assign" *ngIf="auth.loggedIn$ | async">
                        <button
                          mat-stroked-button
                          *ngIf="(members.isEditor$ | async) && !(t.assignees || []).includes((auth.uid$ | async) || '')"
                          [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                          (click)="assignToMe(pid, issue.id!, t)"
                        >
                          {{ 'board.assignToMe' | translate }}
                        </button>
                        <button
                          mat-stroked-button
                          *ngIf="(members.isEditor$ | async) && (t.assignees || []).includes((auth.uid$ | async) || '')"
                          [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                          (click)="unassignMe(pid, issue.id!, t)"
                        >
                          {{ 'board.unassign' | translate }}
                        </button>
                      </div>
                    </mat-card>

                    <div class="issue-placeholder" *ngIf="ts.length === 0">
                      {{ 'board.dropHere' | translate }}
                    </div>
                  </section>
                </ng-container>
              </ng-container>
            </ng-container>
          </div>
        </section>
      </div>
    </ng-container>
  </ng-container>
</section>
