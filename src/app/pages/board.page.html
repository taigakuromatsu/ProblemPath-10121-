
<section class="board-page">
  <header class="board-header">
    <div class="header-left">
      <div class="title-block">
        <h1 class="section-title section-title--info no-truncate">{{ 'nav.board' | translate }}</h1>
        <p class="subtitle text-2line" *ngIf="!selectedProblemId">{{ 'board.selectProblemHint' | translate }}</p>
      </div>
      <div class="problem-select">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>{{ 'label.problem' | translate }}</mat-label>
          <mat-select
            [(ngModel)]="selectedProblemId"
            (ngModelChange)="onSelectProblem($event)"
            [disabled]="(problems$ | async)?.length === 0"
          >
            <mat-option [value]="null">{{ 'common.selectPrompt' | translate }}</mat-option>
            <mat-option *ngFor="let p of (problems$ | async)" [value]="p.id">{{ p.title }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div class="header-right">
      <button
        mat-stroked-button
        type="button"
        (click)="onAddColumn()"
        [disabled]="!(canEdit$ | async)"
      >
        <mat-icon>add</mat-icon>
        {{ 'board.addColumn' | translate }}
      </button>
    </div>
  </header>

  <div class="status-banner" *ngIf="!(isOnline$ | async)">
    <mat-icon>signal_wifi_off</mat-icon>
    <span>{{ 'board.offlineNotice' | translate }}</span>
  </div>

  <mat-card class="board-hint">
    <mat-icon>info</mat-icon>
    <span>{{ 'board.autoProgressHint' | translate }}</span>
  </mat-card>

  <ng-container *ngIf="selectedProblemId as pid">
    <div class="loading" *ngIf="(issues$ | async) === null">{{ 'issue.loading' | translate }}</div>

    <ng-container *ngIf="(issues$ | async) as issues">
      <div class="empty" *ngIf="!issues.length">{{ 'issue.noneYet' | translate }}</div>

      <div class="board-canvas" *ngIf="issues.length">
        <div
          class="board-grid board-lists"
          cdkDropList
          cdkDropListOrientation="horizontal"
          [cdkDropListData]="columns"
          (cdkDropListDropped)="onColumnDrop($event)"
          [cdkDropListDisabled]="!(canEdit$ | async)"
        >
          <section
            class="board-column board-list"
            [ngClass]="col.columnId"
            *ngFor="let col of columns; trackBy: trackColumn"
            [style.--col-accent]="accentFor(col)"
            cdkDrag
            [cdkDragData]="col"
            [cdkDragDisabled]="!(canEdit$ | async)"
          >
            <header class="column-header" [ngClass]="col.columnId">
              <div class="column-header__main">
                <button
                  mat-icon-button
                  type="button"
                  class="column-header__drag"
                  cdkDragHandle
                  [disabled]="!(canEdit$ | async)"
                  [attr.aria-label]="'board.aria.reorderColumn' | translate"
                >
                  <mat-icon>drag_indicator</mat-icon>
                </button>
                <div class="column-title text-1line no-truncate">{{ columnTitle(col) }}</div>
              </div>
              <div class="column-header__actions">
                <span class="column-count count-badge">{{ totalFor(col.columnId) }}</span>
                <button
                  mat-icon-button
                  type="button"
                  (click)="onEditColumn(col)"
                  [disabled]="!(canEdit$ | async)"
                  [attr.aria-label]="'board.aria.editColumn' | translate"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  type="button"
                  (click)="onDeleteColumn(col)"
                  [disabled]="!(canEdit$ | async)"
                  [attr.aria-label]="'board.aria.deleteColumn' | translate"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </header>

            <div class="column-body">
              <ng-container *ngFor="let issue of issues">
                <ng-container *ngIf="tasksMap[key(pid, issue.id!)] | async as tasks">
                  <ng-container *ngIf="tasksForColumn(tasks, col) as ts">
                    <section
                      class="issue-stack list-section"
                      cdkDropList
                      [cdkDropListData]="ts"
                      [cdkDropListConnectedTo]="listIds(issue.id!)"
                      [id]="listId(col, issue.id!)"
                      (cdkDropListDropped)="onListDrop($event, pid, issue.id!)"
                      [cdkDropListEnterPredicate]="canEnter"
                      [cdkDropListDisabled]="!(canEdit$ | async)"
                      cdkDropListOrientation="vertical"
                    >
                      <div class="issue-stack__header list-section__header">
                        <div class="issue-title text-1line no-truncate">{{ issue.title }}</div>
                        <span class="issue-count count-badge">{{ ts.length }} {{ 'board.items' | translate }}</span>
                      </div>

                      <mat-card
                        class="task-card task-card--interactive"
                        *ngFor="let t of ts; trackBy: trackTask"
                        cdkDrag
                        [cdkDragData]="{ task: t, issueId: issue.id }"
                        [cdkDragDisabled]="isBusy(t.id!) || !(canEdit$ | async)"
                        [class.task-card--disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                      >
                        <ng-template cdkDragPreview>
                          <mat-card class="task-card task-card--preview">
                            <div class="task-card__title">{{ t.title }}</div>
                          </mat-card>
                        </ng-template>
                        <ng-template cdkDragPlaceholder>
                          <div class="task-card task-card--placeholder"></div>
                        </ng-template>

                        <!-- 上: 担当者数（ツールチップあり） -->
                        <div class="task-card__meta">
                          <span
                            class="task-assignees meta-chip"
                            *ngIf="(t.assignees?.length || 0) > 0"
                            [matTooltip]="assigneesTooltip(t.assignees, memberDirectory$ | async)"
                            matTooltipPosition="above"
                          >
                            <mat-icon>group</mat-icon>
                            {{ t.assignees?.length || 0 }}
                          </span>
                        </div>

                        <!-- タイトル・説明 -->
                        <div class="task-card__title">{{ t.title }}</div>
                        <p class="task-card__description text-2line" *ngIf="t.description">{{ t.description }}</p>

                        <!-- チップ列 -->
                        <div class="task-card__chips">
                          <mat-chip-set class="task-chip-set">

                            <!-- 優先度 -->
                            <mat-chip
                              appearance="outlined"
                              class="chip chip-priority"
                              [matMenuTriggerFor]="priorityMenu"
                              [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                            >
                              <mat-icon matChipAvatar>flag</mat-icon>
                              <span>{{ t.priority ? ('priority.' + t.priority | translate) : ('common.none' | translate) }}</span>
                              <mat-icon>arrow_drop_down</mat-icon>
                            </mat-chip>

                            <mat-menu #priorityMenu="matMenu">
                              <button
                                mat-menu-item
                                (click)="setTaskPriority(pid, issue.id!, t, 'high')"
                                [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                              >
                                <mat-icon>priority_high</mat-icon>
                                <span>{{ 'priority.high' | translate }}</span>
                              </button>
                              <button
                                mat-menu-item
                                (click)="setTaskPriority(pid, issue.id!, t, 'mid')"
                                [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                              >
                                <mat-icon>flag</mat-icon>
                                <span>{{ 'priority.mid' | translate }}</span>
                              </button>
                              <button
                                mat-menu-item
                                (click)="setTaskPriority(pid, issue.id!, t, 'low')"
                                [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                              >
                                <mat-icon>south</mat-icon>
                                <span>{{ 'priority.low' | translate }}</span>
                              </button>
                            </mat-menu>

                            <!-- ステータス（列選択） -->
                            <mat-chip
                              appearance="outlined"
                              class="chip chip-status"
                              [matMenuTriggerFor]="statusMenu"
                              [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                            >
                              <mat-icon matChipAvatar>timeline</mat-icon>
                              <span>{{ currentColumnTitle(t) }}</span>
                              <mat-icon>arrow_drop_down</mat-icon>
                            </mat-chip>

                            <mat-menu #statusMenu="matMenu">
                              <button
                                mat-menu-item
                                *ngFor="let colOpt of columns; trackBy: trackColumn"
                                (click)="moveTaskToColumn(pid, issue.id!, t, colOpt)"
                                [disabled]="isBusy(t.id!) || !(canEdit$ | async) || isTaskInColumn(t, colOpt)"
                              >
                                <mat-icon *ngIf="colOpt.categoryHint === 'done'">check_circle</mat-icon>
                                <mat-icon *ngIf="colOpt.categoryHint === 'in_progress'">sync</mat-icon>
                                <mat-icon *ngIf="colOpt.categoryHint === 'not_started'">play_disabled</mat-icon>
                                <mat-icon
                                  *ngIf="colOpt.categoryHint !== 'done' && colOpt.categoryHint !== 'in_progress' && colOpt.categoryHint !== 'not_started'">
                                  more_horiz
                                </mat-icon>
                                <span>{{ columnTitle(colOpt) }}</span>
                              </button>
                            </mat-menu>

                            <!-- 期限 -->
                            <mat-chip appearance="outlined" class="chip chip-due">
                              <mat-icon matChipAvatar>event</mat-icon>
                              <ng-container *ngIf="t.dueDate; else noDue">
                                {{ t.dueDate | date:'yyyy/MM/dd' }}
                              </ng-container>
                              <ng-template #noDue>{{ 'common.none' | translate }}</ng-template>
                            </mat-chip>

                          </mat-chip-set>
                        </div>

                        <div class="task-card__assign" *ngIf="auth.loggedIn$ | async">
                          <button
                            mat-stroked-button
                            *ngIf="(members.isEditor$ | async) && !(t.assignees || []).includes((auth.uid$ | async) || '')"
                            [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                            (click)="assignToMe(pid, issue.id!, t)"
                          >
                            {{ 'board.assignToMe' | translate }}
                          </button>
                          <button
                            mat-stroked-button
                            *ngIf="(members.isEditor$ | async) && (t.assignees || []).includes((auth.uid$ | async) || '')"
                            [disabled]="isBusy(t.id!) || !(canEdit$ | async)"
                            (click)="unassignMe(pid, issue.id!, t)"
                          >
                            {{ 'board.unassign' | translate }}
                          </button>
                        </div>
                      </mat-card>

                      <div class="issue-placeholder" *ngIf="ts.length === 0">
                        {{ 'board.dropHere' | translate }}
                      </div>
                    </section>
                  </ng-container>
                </ng-container>
              </ng-container>
            </div>
          </section>
        </div>
      </div>
    </ng-container>
  </ng-container>
</section>

