<section class="page analytics-page">
  <header class="page__header">
    <div class="page__title-row">
      <h1 class="section-title section-title--info no-truncate">
        {{ 'analytics.title' | translate }}
      </h1>
      <button type="button" mat-stroked-button class="analytics-page__refresh-button" (click)="onRefreshAnalytics()">
        再集計
      </button>
    </div>
    <p class="page__subtitle">{{ 'analytics.subtitle' | translate }}</p>
    <p class="page__project" *ngIf="projectName$ | async as projectName; else idLine">
      {{ 'reports.projectNameLine' | translate: { name: projectName } }}
    </p>
    <ng-template #idLine>
      <p class="page__project" *ngIf="projectId$ | async as projectId">
        {{ 'analytics.projectContext' | translate: { id: projectId } }}
      </p>
    </ng-template>
  </header>

  <ng-container *ngIf="summary$ | async as summary">
    <div class="analytics-page__metrics">
      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">task_alt</mat-icon>
          <mat-card-title>{{ 'analytics.cards.completedTasks7d' | translate }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="metric-card__value">{{ summary.completedTasks7d }}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">schedule</mat-icon>
          <mat-card-title>{{ 'analytics.cards.avgLeadTime30d' | translate }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="metric-card__value">
            {{ summary.avgLeadTime30dDays | number: '1.0-1' }}
            <span class="metric-card__unit">{{ 'analytics.cards.avgLeadTime30dUnit' | translate }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">trending_down</mat-icon>
          <mat-card-title>{{ 'analytics.cards.lateRateThisWeek' | translate }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="metric-card__value">{{ summary.lateRateThisWeekPercent | number: '1.0-1' }}%</div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card class="analytics-page__status-card">
      <mat-card-header>
        <mat-card-title>{{ 'analytics.statusBreakdown.title' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <ng-container *ngIf="statusEntries$ | async as statusEntries">
          <div class="status-row" *ngFor="let entry of statusEntries">
            <div class="status-row__meta">
              <span class="status-row__label">{{ entry.label | translate }}</span>
              <span class="status-row__value">{{ entry.count }}</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="entry.percent"></mat-progress-bar>
          </div>
        </ng-container>
      </mat-card-content>
    </mat-card>

    <mat-card class="analytics-page__problem-card">
      <mat-card-header class="problem-progress__header">
        <div class="problem-progress__header-main">
          <mat-card-title>Problem別の進捗（平均%）</mat-card-title>
          <mat-icon
            class="problem-progress__info"
            matTooltip="この値は、そのProblem内にあるタスクの進捗率(progress)の平均です。各タスクはボード上で置かれた列に応じて自動的に進捗率が更新されます。"
          >info</mat-icon>
        </div>
        <mat-card-subtitle class="problem-progress__subtitle">
          列を「未着手 / 対応中 / レビュー中 / 完了」などに分けると、その列にあるタスクの進捗率が使われ、平均値としてここに表示されます。
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div *ngIf="summary.problemProgress.length; else noProblems" class="problem-progress">
          <div class="problem-progress__item" *ngFor="let problem of summary.problemProgress">
            <div class="problem-progress__meta">
              <span class="problem-progress__title">{{ problem.title }}</span>
              <span class="problem-progress__value">{{ problem.percent | number: '1.0-0' }}%</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="problem.percent"></mat-progress-bar>
          </div>
        </div>
        <ng-template #noProblems>
          <p class="muted">{{ 'analytics.problemProgress.empty' | translate }}</p>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- ここから新設：個人タスクデータ -->
    <mat-card class="analytics-page__personal-card">
      <mat-card-header>
        <mat-card-title>{{ 'analytics.personal.title' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content *ngIf="mySummary$ | async as me">
        <div class="personal-card__metrics">
          <div class="personal-metric">
            <div class="personal-metric__label">{{ 'analytics.personal.completedTasks7d' | translate }}</div>
            <div class="personal-metric__value">{{ me.completedTasks7d }}</div>
          </div>
          <div class="personal-metric">
            <div class="personal-metric__label">{{ 'analytics.personal.lateRateThisWeek' | translate }}</div>
            <div class="personal-metric__value">{{ me.lateRateThisWeekPercent | number: '1.0-1' }}%</div>
          </div>
          <div class="personal-metric">
            <div class="personal-metric__label">{{ 'analytics.personal.avgLeadTime30d' | translate }}</div>
            <div class="personal-metric__value">
              {{ me.avgLeadTime30dDays | number: '1.0-1' }}
              <span class="metric-card__unit">{{ 'analytics.cards.avgLeadTime30dUnit' | translate }}</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="personal-status" *ngIf="myStatusEntries$ | async as myEntries">
          <div class="status-row" *ngFor="let entry of myEntries">
            <div class="status-row__meta">
              <span class="status-row__label">{{ entry.label | translate }}</span>
              <span class="status-row__value">{{ entry.count }}</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="entry.percent"></mat-progress-bar>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </ng-container>
</section>

